<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/modules/carrington-build/vendor/carrington-build/modules/loop/loop.php - wp-flawless</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://a3d72a45d111006ec192-ec5b80a12b0b09b4d52373336afb4254.r80.cf1.rackcdn.com/usability-dynamics.png" title="wp-flawless"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/API.html">API</a></li>
            
                <li><a href="../classes/Carrington.html">Carrington</a></li>
            
                <li><a href="../classes/Extended_Taxonomies.html">Extended_Taxonomies</a></li>
            
                <li><a href="../classes/Flawless.API.html">Flawless.API</a></li>
            
                <li><a href="../classes/Flawless.Asset.html">Flawless.Asset</a></li>
            
                <li><a href="../classes/Flawless.Branded_Login.html">Flawless.Branded_Login</a></li>
            
                <li><a href="../classes/Flawless.BuddyPress.html">Flawless.BuddyPress</a></li>
            
                <li><a href="../classes/Flawless.Content.html">Flawless.Content</a></li>
            
                <li><a href="../classes/Flawless.Element.html">Flawless.Element</a></li>
            
                <li><a href="../classes/Flawless.Flawless\Shortcode.html">Flawless.Flawless\Shortcode</a></li>
            
                <li><a href="../classes/Flawless.Management.html">Flawless.Management</a></li>
            
                <li><a href="../classes/Flawless.Mobile.html">Flawless.Mobile</a></li>
            
                <li><a href="../classes/Flawless.Navbars.html">Flawless.Navbars</a></li>
            
                <li><a href="../classes/Flawless.Schema.html">Flawless.Schema</a></li>
            
                <li><a href="../classes/Flawless.Settings.html">Flawless.Settings</a></li>
            
                <li><a href="../classes/Flawless.Styles.html">Flawless.Styles</a></li>
            
                <li><a href="../classes/Flawless.Utility.html">Flawless.Utility</a></li>
            
                <li><a href="../classes/Flawless.Widget.html">Flawless.Widget</a></li>
            
                <li><a href="../classes/flawless_wpp_extensions.html">flawless_wpp_extensions</a></li>
            
                <li><a href="../classes/Legacy.html">Legacy</a></li>
            
                <li><a href="../classes/License.html">License</a></li>
            
                <li><a href="../classes/Loader.html">Loader</a></li>
            
                <li><a href="../classes/Log.html">Log</a></li>
            
                <li><a href="../classes/Maintenance.html">Maintenance</a></li>
            
                <li><a href="../classes/Models.html">Models</a></li>
            
                <li><a href="../classes/Module.html">Module</a></li>
            
                <li><a href="../classes/Multisite.html">Multisite</a></li>
            
                <li><a href="../classes/SaaS.html">SaaS</a></li>
            
                <li><a href="../classes/Shortcode.html">Shortcode</a></li>
            
                <li><a href="../classes/Shortcodes.html">Shortcodes</a></li>
            
                <li><a href="../classes/Template Methods.html">Template Methods</a></li>
            
                <li><a href="../classes/Theme.html">Theme</a></li>
            
                <li><a href="../classes/UI.html">UI</a></li>
            
                <li><a href="../classes/Utility.html">Utility</a></li>
            
                <li><a href="../classes/Views.html">Views</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/API.html">API</a></li>
            
                <li><a href="../modules/Branded Login.html">Branded Login</a></li>
            
                <li><a href="../modules/Carrington.html">Carrington</a></li>
            
                <li><a href="../modules/Carrington Build.html">Carrington Build</a></li>
            
                <li><a href="../modules/carrington-build.html">carrington-build</a></li>
            
                <li><a href="../modules/cfct_build.html">cfct_build</a></li>
            
                <li><a href="../modules/default.html">default</a></li>
            
                <li><a href="../modules/Flawless.html">Flawless</a></li>
            
                <li><a href="../modules/Loader.html">Loader</a></li>
            
                <li><a href="../modules/Log.html">Log</a></li>
            
                <li><a href="../modules/Maintenence.html">Maintenence</a></li>
            
                <li><a href="../modules/Management.html">Management</a></li>
            
                <li><a href="../modules/Multisite.html">Multisite</a></li>
            
                <li><a href="../modules/SaaS.html">SaaS</a></li>
            
                <li><a href="../modules/Services_JSON.html">Services_JSON</a></li>
            
                <li><a href="../modules/Shortcodes.html">Shortcodes</a></li>
            
                <li><a href="../modules/taxonomy-landing

This file is part of Taxonomy Landing for WordPress
http:__github.com_crowdfavorite_wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http:__crowdfavorite.com

Released under the GPL license
http:__www.opensource.org_licenses_gpl-license.php

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************.html">taxonomy-landing

This file is part of Taxonomy Landing for WordPress
http://github.com/crowdfavorite/wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http://crowdfavorite.com

Released under the GPL license
http://www.opensource.org/licenses/gpl-license.php

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************</a></li>
            
                <li><a href="../modules/taxonomy-landing

This file is part of Taxonomy Landing for WordPress
https:__github.com_crowdfavorite_wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http:__crowdfavorite.com

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************.html">taxonomy-landing

This file is part of Taxonomy Landing for WordPress
https://github.com/crowdfavorite/wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http://crowdfavorite.com

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************</a></li>
            
                <li><a href="../modules/Theme UI.html">Theme UI</a></li>
            
                <li><a href="../modules/UI.html">UI</a></li>
            
                <li><a href="../modules/UsabilityDynamics.html">UsabilityDynamics</a></li>
            
                <li><a href="../modules/Utility.html">Utility</a></li>
            
                <li><a href="../modules/Views.html">Views</a></li>
            
                <li><a href="../modules/WP-Property.html">WP-Property</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: core/modules/carrington-build/vendor/carrington-build/modules/loop/loop.php</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&lt;?php 

/**
 * Once upon a time there was a version of the Loop Module
 * that was a bit funny. This filter fixes the data structure
 * from that time period to work with the current data structure.
 * 
 * If your data is affected by this once unfortunate version then
 * copy and paste this function, then uncomment it in your functions.php
 * file. DO NOT enable this filter here as it will possibly get commented 
 * or removed in a future update.
 *
 * @param array $data 
 * @param object $module 
 * @return array
 */
/*
function the_cb_lemay_fix($data, $module) {
  if (!empty($data[$module-&gt;gfn(&#x27;taxonomy-1&#x27;)])) {
    $i = 1;
    do {
      $data[$module-&gt;gfn(&#x27;tax_input&#x27;)][$data[$module-&gt;gfn(&#x27;taxonomy-&#x27;.$i)]] = $data[$module-&gt;gfn(&#x27;tax_filter-&#x27;.$i)];
      unset($data[$module-&gt;gfn(&#x27;taxonomy-&#x27;.$i)], $data[$module-&gt;gfn(&#x27;tax_filter-&#x27;.$i)]);
      $i++;
    } while (!empty($data[$module-&gt;gfn(&#x27;taxonomy-&#x27;.$i)]));
  }
  return $data;
}
add_filter(&#x27;cfct-migrate-loop-data&#x27;, &#x27;the_cb_lemay_fix&#x27;, 10, 2);
*/

/** 
 * Carrington Build Loop Module
 * Performs a loop based on several different filter criteria
 * set via admin interface.
 *
 * There&#x27;s a base class that outputs full loop content, but 2 class
 * extensions which extend it, but change it to &quot;excerpts&quot; or &quot;titles&quot;
 *
 * Don&#x27;t forget to call cfct_module_loop::init() in your constructor if you
 * derive from this class!
 */
if (!class_exists(&#x27;cfct_module_loop&#x27;) &amp;&amp; class_exists(&#x27;cfct_build_module&#x27;)) {
  class cfct_module_loop extends cfct_build_module {
    const POST_TYPES_FILTER = &#x27;cfct-module-loop-post-types&#x27;;
    const TAXONOMY_TYPES_FILTER = &#x27;cfct-module-loop-taxonomy-types&#x27;;
    
    protected $_deprecated_id = &#x27;cfct-module-loop&#x27;; // deprecated property, not needed for new module development

    protected $default_display_args = array(
      &#x27;ignore_sticky_posts&#x27; =&gt; 1
    );

    protected $content_display_options = array();    
    protected $default_content_display = &#x27;title&#x27;;
    protected $default_item_count = 10;
    protected $default_item_offset = 0;
    protected $default_post_type = &#x27;post&#x27;;
    protected $default_relation = &#x27;AND&#x27;;
    protected $default_tax_select_text = &#x27;&amp;mdash; Select taxonomy to filter &amp;mdash;&#x27;;
    protected $js_base;

    public function __construct() {
      $opts = array(
        &#x27;description&#x27; =&gt; __(&#x27;Choose and display a set of posts (any post type).&#x27;, &#x27;carrington-build&#x27;),
        &#x27;icon&#x27; =&gt; &#x27;loop/icon.png&#x27;
      );
      parent::__construct(&#x27;cfct-module-loop&#x27;, __(&#x27;Loop&#x27;, &#x27;carrington-build&#x27;), $opts);
      $this-&gt;init();
    }

    protected function init() {
      // do this at init &#x27;cause we can&#x27;t do intl in member declarations
      $this-&gt;content_display_options = array(
        &#x27;title&#x27; =&gt; __(&#x27;Titles Only&#x27;, &#x27;carrington-build&#x27;),
        &#x27;excerpt&#x27; =&gt; __(&#x27;Titles &amp;amp; Excerpts&#x27;, &#x27;carrington-build&#x27;),
        &#x27;content&#x27; =&gt; __(&#x27;Titles &amp;amp; Post Content&#x27;, &#x27;carrington-build&#x27;)
      );
      
      // We need to enqueue the suggest script so we can use it later for type-ahead search
      $this-&gt;enqueue_scripts();

      // Taxonomy Filter Request Handler
      $this-&gt;register_ajax_handler($this-&gt;id_base.&#x27;-get-new-taxonomy-block&#x27;, array($this, &#x27;get_new_taxonomy_block&#x27;));
      add_action(&#x27;wp_ajax_cf_taxonomy_filter_autocomplete&#x27;, array($this, &#x27;taxonomy_filter_autocomplete&#x27;));      
    }

# Data upgrade

    /**
     * Function to translate legacy loop save data in to &quot;modern&quot; loop save data.
     * This is not going to be standard practice. It was unavoidable in the 1.1 upgrade.
     *
     * @param array $data 
     * @return array
     */
    protected function migrate_data($data) {
      if (!isset($data[$this-&gt;gfn(&#x27;post_type&#x27;)])) {
        $data[$this-&gt;gfn(&#x27;post_type&#x27;)] = array();
      }
      // post types used to be singular and stored as strings
      if (!is_array($data[$this-&gt;gfn(&#x27;post_type&#x27;)])) {
        $data[$this-&gt;gfn(&#x27;post_type&#x27;)] = (array) $data[$this-&gt;gfn(&#x27;post_type&#x27;)];
      }
    
      // tax_filter used to be the name, now its tax_input and stores much more data
      if (isset($data[$this-&gt;gfn(&#x27;tax_filter&#x27;)]) &amp;&amp; !empty($data[$this-&gt;gfn(&#x27;tax_filter&#x27;)])) {
        $data[$this-&gt;gfn(&#x27;tax_input&#x27;)][$data[$this-&gt;gfn(&#x27;taxonomy&#x27;)]] = (array) $data[$this-&gt;gfn(&#x27;tax_filter&#x27;)];
        unset($data[$this-&gt;gfn(&#x27;tax_filter&#x27;)], $data[$this-&gt;gfn(&#x27;taxonomy&#x27;)]);
      }
    
      return apply_filters(&#x27;cfct-migrate-loop-data&#x27;, $data, $this);
    }
  
# Admin Ajax
    
    /**
     * Type ahead search for tag like term completion
     *
     * @return string
     */
    public function taxonomy_filter_autocomplete() {
      $search = strip_tags(stripslashes($_GET[&#x27;q&#x27;]));
      $tax = strip_tags(stripslashes($_GET[&#x27;tax&#x27;]));

      $items = array();
      if (!empty($search)) {
        $terms = get_terms($tax, array(
          &#x27;search&#x27; =&gt; $search
        ));
        if (is_array($terms)) {
          foreach ($terms as $term) {
            $items[] = $term-&gt;name;
          }
        }
      }

      header(&#x27;content-type: text/plain&#x27;);
      if (!empty($items)) {
        echo implode(&quot;\n&quot;, $items);
      }
      else {
        echo __(&#x27;No Matching Taxonomies&#x27;, &#x27;carrington-build&#x27;);
      }
      exit;
    }
    
    /**
     * Return a taxonomy filter section for the admin-ui
     *
     * @param array $args 
     * @return object cfct_message
     */
    public function get_new_taxonomy_block($args) {
      $success = $html = false;
      
      $taxonomy = get_taxonomy(esc_attr($args[&#x27;taxonomy&#x27;]));
      if (!empty($taxonomy) || !is_wp_error($taxonomy)) {
        $success = true;
        $html = $this-&gt;get_taxonomy_filter_item($taxonomy, array());
      }
      return $this-&gt;ajax_response($success, $html, &#x27;get-new-taxonomy-block&#x27;);
    }

# Output

    /**
     * Display the module
     *
     * @param array $data - saved module data
     * @param array $args - previously set up arguments from a child class
     * @return string HTML
     */
    public function display($data) {
      $data = $this-&gt;migrate_data($data);
      
      $args = $this-&gt;set_display_args($data);

      // put it all together now
      $title = ( !empty($data[$this-&gt;get_field_name(&#x27;title&#x27;)]) ? esc_html($data[$this-&gt;get_field_name(&#x27;title&#x27;)]) : &#x27;&#x27;);

      $content = $this-&gt;get_custom_loop($data, apply_filters($this-&gt;id_base.&#x27;-query-args&#x27;, $args, $data));
      if ((!empty($data[$this-&gt;get_field_name(&#x27;show_pagination&#x27;)]) ? $data[$this-&gt;get_field_name(&#x27;show_pagination&#x27;)] : &#x27;&#x27;) == &#x27;yes&#x27; &amp;&amp; !empty($data[$this-&gt;get_field_name(&#x27;next_pagination_link&#x27;)])) {
        $pagination_url = $data[$this-&gt;get_field_name(&#x27;next_pagination_link&#x27;)];
        $pagination_text = esc_html($data[$this-&gt;get_field_name(&#x27;next_pagination_text&#x27;)]);
      }
      else {
        $pagination_url = $pagination_text = null;
      }

      return $this-&gt;load_view($data, compact(&#x27;title&#x27;, &#x27;content&#x27;, &#x27;pagination_url&#x27;, &#x27;pagination_text&#x27;));
    }

    protected function set_display_args($data) {
      // Set default
      $args = $this-&gt;default_display_args;
      
      // Figure out post type or use default
      if (isset($data[$this-&gt;get_field_name(&#x27;post_type&#x27;)])) {
        $post_type = $data[$this-&gt;get_field_name(&#x27;post_type&#x27;)];
        if (!empty($post_type)) {
          $args[&#x27;post_type&#x27;] = $post_type;
        }
      }
      
      $tax_input = $this-&gt;get_data(&#x27;tax_input&#x27;, $data);
      if (!empty($tax_input)) {
        $relation = $this-&gt;get_data(&#x27;relation&#x27;, $data, $this-&gt;default_relation);
        if (!empty($relation)) {
          $args[&#x27;tax_query&#x27;][&#x27;relation&#x27;] = $relation;
        }
        foreach ($tax_input as $taxonomy =&gt; $terms) {
          $taxonomy = get_taxonomy($taxonomy);
          $args[&#x27;tax_query&#x27;][] = array(
            &#x27;taxonomy&#x27; =&gt; $taxonomy-&gt;name,
            &#x27;terms&#x27; =&gt; $terms,
            &#x27;field&#x27; =&gt; &#x27;term_id&#x27;
          );
        }
      }

      // Post Parent
      // @deprecated? @TODO check if any child-modules are using this ~sp
      $args[&#x27;post_parent&#x27;] = !empty($data[$this-&gt;get_field_name(&#x27;parent&#x27;)]) ? $data[$this-&gt;get_field_name(&#x27;parent&#x27;)] : null;

      // Filter by Author
      $args[&#x27;author&#x27;] = !empty($data[$this-&gt;get_field_name(&#x27;author&#x27;)]) ? $data[$this-&gt;get_field_name(&#x27;author&#x27;)] : null;

      // Number of items
      $args[&#x27;posts_per_page&#x27;] = intval(!empty($data[$this-&gt;get_field_name(&#x27;item_count&#x27;)]) ? $data[$this-&gt;get_field_name(&#x27;item_count&#x27;)] : $this-&gt;default_item_count);

      // Item offset
      $args[&#x27;offset&#x27;] = intval(isset($data[$this-&gt;get_field_name(&#x27;item_offset&#x27;)]) ? $data[$this-&gt;get_field_name(&#x27;item_offset&#x27;)] : $this-&gt;default_item_offset);

      // Don&#x27;t include this post, otherwise we&#x27;ll get an infinite loop
      global $post;
      $args[&#x27;post__not_in&#x27;] = array($post-&gt;ID);
      $args[&#x27;display&#x27;] = $data[$this-&gt;get_field_name(&#x27;display_type&#x27;)];
      
      return $args;
    }

    /**
     * Returns the HTML of the custom loop
     *
     * @param array $data Custom options from the module
     * @param array $args
     * @return string HTML
     */
    protected function get_custom_loop($data, $args = array()) {
      if ($args[&#x27;display&#x27;] == &#x27;title&#x27;) {
        return $this-&gt;get_custom_loop_ul($data, $args);
      }
      else {
        return $this-&gt;get_custom_loop_default($data, $args);
      }
    }

    /**
     * Returns the loop as default, with content or excerpt.  No list.
     *
     * @param string $data
     * @param string $args
     * @return string HTML
     */
    protected function get_custom_loop_default($data, $args = array()) {
      $this-&gt;cache_global_post();
      
      ob_start();
      $query = new WP_Query($args);
      do_action($this-&gt;id_base.&#x27;-query-results&#x27;, $query);

      if ($query-&gt;have_posts()) {
        while ($query-&gt;have_posts()) {
          $query-&gt;the_post();

          ob_start();
          if ($args[&#x27;display&#x27;] == &#x27;excerpt&#x27;) {
            $this-&gt;post_item_excerpt();
          }
          elseif ($args[&#x27;display&#x27;] == &#x27;content&#x27;) {
            $this-&gt;post_item_content();
          }
          $item = ob_get_clean();
          $item = apply_filters(&#x27;cfct-build-loop-item&#x27;, $item, $data, $args, $query); // @TODO deprecate in 1.2? doesn&#x27;t scale well when extending the loop object
          echo apply_filters($this-&gt;id_base.&#x27;-loop-item&#x27;, $item, $data, $args, $query);
        }
      }
      $html = ob_get_clean();
      $this-&gt;reset_global_post();
      
      $html = apply_filters(&#x27;cfct-build-loop-html&#x27;, $html, $data, $args, $query); // @TODO deprecate in 1.2? doesn&#x27;t scale well when extending the loop object
      $html = apply_filters($this-&gt;id_base.&#x27;loop-html&#x27;, $html, $data, $args, $query);
      return $html;
    }

    /**
     * Returns the loop as a UL with LIs
     *
     * @param string $data
     * @param string $args
     * @return string HTML
     */
    protected function get_custom_loop_ul($data, $args = array()) {
      $this-&gt;cache_global_post();
      
      ob_start();
      $query = new WP_Query($args);
      do_action($this-&gt;id_base.&#x27;-query-results&#x27;, $query);

      $class = $this-&gt;id_base;
      $class = apply_filters(&#x27;cfct-build-loop-title-ul-class&#x27;, $class, $data, $args, $query); // @TODO deprecate in 1.2? doesn&#x27;t scale well when extending the loop object
      $class = apply_filters($this-&gt;id_base.&#x27;-title-ul-class&#x27;, $class, $data, $args, $query);

      if ($query-&gt;have_posts()) {
        echo &#x27;
          &lt;ul class=&quot;&#x27;.esc_attr($class).&#x27;&quot;&gt;&#x27;;
        while ($query-&gt;have_posts()) {
          $query-&gt;the_post();

          ob_start();
          $this-&gt;post_item_li();
          
          $item = ob_get_clean();
          $item = apply_filters(&#x27;cfct-build-loop-item&#x27;, $item, $data, $args, $query); // @TODO deprecate in 1.2? doesn&#x27;t scale well when extending the loop object
          echo apply_filters($this-&gt;id_base.&#x27;-loop-item&#x27;, $item, $data, $args, $query);
        }
        echo &#x27;
          &lt;/ul&gt;&lt;!-- /&#x27;.esc_attr($class).&#x27; --&gt;&#x27;;
      }
      $html = ob_get_clean();
      $this-&gt;reset_global_post();

      $html = apply_filters(&#x27;cfct-build-loop-html&#x27;, $html, $data, $args, $query); // @TODO deprecate in 1.2? doesn&#x27;t scale well when extending the loop object
      $html = apply_filters($this-&gt;id_base.&#x27;-loop-html&#x27;, $html, $data, $args, $query);
      return $html;
    }

    /**
     * Outputs the post item for an LI
     *
     * @return void - function echoes
     */
    protected function post_item_li() {
      ?&gt;
      &lt;li&gt;&lt;a href=&quot;&lt;?php the_permalink(); ?&gt;&quot;&gt;&lt;?php the_title(); ?&gt;&lt;/a&gt;&lt;/li&gt;
      &lt;?php
    }

    /**
     * The way the twentyten theme does the excerpt of a post
     *
     * @return void - function echoes
     */
    protected function the_excerpt() {
      ?&gt;
      &lt;div data-post-id=&quot;post-&lt;?php the_ID(); ?&gt;&quot; &lt;?php post_class(); ?&gt;&gt;
        &lt;h2 class=&quot;entry-title&quot;&gt;&lt;a href=&quot;&lt;?php the_permalink(); ?&gt;&quot; title=&quot;&lt;?php printf( esc_attr__( &#x27;Permalink to %s&#x27;, &#x27;carrington-build&#x27; ), the_title_attribute( &#x27;echo=0&#x27; ) ); ?&gt;&quot; rel=&quot;bookmark&quot;&gt;&lt;?php the_title(); ?&gt;&lt;/a&gt;&lt;/h2&gt;

        &lt;div class=&quot;entry-meta&quot;&gt;
          &lt;?php $this-&gt;posted_on(); ?&gt;
        &lt;/div&gt;&lt;!-- .entry-meta --&gt;

        &lt;div class=&quot;entry-summary&quot;&gt;
          &lt;?php the_excerpt(); ?&gt;
        &lt;/div&gt;&lt;!-- .entry-summary --&gt;

        &lt;div class=&quot;entry-utility&quot;&gt;
          &lt;?php if ( count( get_the_category() ) ) : ?&gt;
            &lt;span class=&quot;cat-links&quot;&gt;
              &lt;?php printf( __( &#x27;&lt;span class=&quot;%1$s&quot;&gt;Posted in&lt;/span&gt; %2$s&#x27;, &#x27;carrington-build&#x27; ), &#x27;entry-utility-prep entry-utility-prep-cat-links&#x27;, get_the_category_list( &#x27;, &#x27; ) ); ?&gt;
            &lt;/span&gt;
            &lt;span class=&quot;meta-sep&quot;&gt;|&lt;/span&gt;
          &lt;?php endif; ?&gt;
          &lt;?php
            $tags_list = get_the_tag_list( &#x27;&#x27;, &#x27;, &#x27; );
            if ( $tags_list ):
          ?&gt;
            &lt;span class=&quot;tag-links&quot;&gt;
              &lt;?php printf( __( &#x27;&lt;span class=&quot;%1$s&quot;&gt;Tagged&lt;/span&gt; %2$s&#x27;, &#x27;carrington-build&#x27; ), &#x27;entry-utility-prep entry-utility-prep-tag-links&#x27;, $tags_list ); ?&gt;
            &lt;/span&gt;
            &lt;span class=&quot;meta-sep&quot;&gt;|&lt;/span&gt;
          &lt;?php endif; ?&gt;
          &lt;span class=&quot;comments-link&quot;&gt;&lt;?php comments_popup_link( __( &#x27;Leave a comment&#x27;, &#x27;carrington-build&#x27; ), __( &#x27;1 Comment&#x27;, &#x27;carrington-build&#x27; ), __( &#x27;% Comments&#x27;, &#x27;carrington-build&#x27; ) ); ?&gt;&lt;/span&gt;
          &lt;?php edit_post_link( __( &#x27;Edit&#x27;, &#x27;carrington-build&#x27; ), &#x27;&lt;span class=&quot;meta-sep&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;edit-link&quot;&gt;&#x27;, &#x27;&lt;/span&gt;&#x27; ); ?&gt;
        &lt;/div&gt;&lt;!-- .entry-utility --&gt;
      &lt;/div&gt;&lt;!-- #post-&lt;?php the_ID(); ?&gt;## --&gt;
      &lt;?php
    }
    
    /**
     * Output a content block
     *
     * @return void - function echoes
     */
    protected function the_content() {
      ?&gt;
      &lt;div data-post-id=&quot;post-&lt;?php the_ID(); ?&gt;&quot; &lt;?php post_class(); ?&gt;&gt;
        &lt;h2 class=&quot;entry-title&quot;&gt;&lt;a href=&quot;&lt;?php the_permalink(); ?&gt;&quot; title=&quot;&lt;?php printf( esc_attr__( &#x27;Permalink to %s&#x27;, &#x27;carrington-build&#x27; ), the_title_attribute( &#x27;echo=0&#x27; ) ); ?&gt;&quot; rel=&quot;bookmark&quot;&gt;&lt;?php the_title(); ?&gt;&lt;/a&gt;&lt;/h2&gt;

        &lt;div class=&quot;entry-meta&quot;&gt;
          &lt;?php $this-&gt;posted_on(); ?&gt;
        &lt;/div&gt;&lt;!-- .entry-meta --&gt;

        &lt;div class=&quot;entry-summary&quot;&gt;
          &lt;?php the_content(); ?&gt;
        &lt;/div&gt;&lt;!-- .entry-summary --&gt;

        &lt;div class=&quot;entry-utility&quot;&gt;
          &lt;?php if ( count( get_the_category() ) ) : ?&gt;
            &lt;span class=&quot;cat-links&quot;&gt;
              &lt;?php printf( __( &#x27;&lt;span class=&quot;%1$s&quot;&gt;Posted in&lt;/span&gt; %2$s&#x27;, &#x27;carrington-build&#x27; ), &#x27;entry-utility-prep entry-utility-prep-cat-links&#x27;, get_the_category_list( &#x27;, &#x27; ) ); ?&gt;
            &lt;/span&gt;
            &lt;span class=&quot;meta-sep&quot;&gt;|&lt;/span&gt;
          &lt;?php endif; ?&gt;
          &lt;?php
            $tags_list = get_the_tag_list( &#x27;&#x27;, &#x27;, &#x27; );
            if ( $tags_list ):
          ?&gt;
            &lt;span class=&quot;tag-links&quot;&gt;
              &lt;?php printf( __( &#x27;&lt;span class=&quot;%1$s&quot;&gt;Tagged&lt;/span&gt; %2$s&#x27;, &#x27;carrington-build&#x27; ), &#x27;entry-utility-prep entry-utility-prep-tag-links&#x27;, $tags_list ); ?&gt;
            &lt;/span&gt;
            &lt;span class=&quot;meta-sep&quot;&gt;|&lt;/span&gt;
          &lt;?php endif; ?&gt;
          &lt;span class=&quot;comments-link&quot;&gt;&lt;?php comments_popup_link( __( &#x27;Leave a comment&#x27;, &#x27;carrington-build&#x27; ), __( &#x27;1 Comment&#x27;, &#x27;carrington-build&#x27; ), __( &#x27;% Comments&#x27;, &#x27;carrington-build&#x27; ) ); ?&gt;&lt;/span&gt;
          &lt;?php edit_post_link( __( &#x27;Edit&#x27;, &#x27;carrington-build&#x27; ), &#x27;&lt;span class=&quot;meta-sep&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;edit-link&quot;&gt;&#x27;, &#x27;&lt;/span&gt;&#x27; ); ?&gt;
        &lt;/div&gt;&lt;!-- .entry-utility --&gt;
      &lt;/div&gt;&lt;!-- #post-&lt;?php the_ID(); ?&gt;## --&gt;
      &lt;?php
    }

    /**
     * Run excerpt functions
     *
     * @return void
     */
    protected function post_item_excerpt() {
      if (function_exists(&#x27;cfct_excerpt&#x27;)) {
        cfct_excerpt();
      }
      else {
        $this-&gt;the_excerpt();
      }
    }

    /**
     * Run content functions
     *
     * @return void
     */
    protected function post_item_content() {
      if (function_exists(&#x27;cfct_content&#x27;)) {
        cfct_content();
      }
      else {
        $this-&gt;the_content();
      }
    }

# Admin Form

    /**
     * Output the Admin Form
     *
     * @param array $data - saved module data
     * @return string HTML
     */
    public function admin_form($data) {
      $data = $this-&gt;migrate_data($data);
      return &#x27;
        &lt;div id=&quot;&#x27;.$this-&gt;id_base.&#x27;-admin-form-wrapper&quot;&gt;&#x27;.
          $this-&gt;admin_form_title($data).
          $this-&gt;admin_form_post_types($data).
          $this-&gt;admin_form_taxonomy_filter($data).
          $this-&gt;admin_form_display_options($data).
        &#x27;&lt;/div&gt;&#x27;;
    }

    /**
     * Show module title input
     *
     * @param array $data - saved module data
     * @return string HTML
     */
    public function admin_form_title($data) {
      return &#x27;
        &lt;fieldset class=&quot;cfct-form-section&quot;&gt;
          &lt;!-- title --&gt;
          &lt;legend&gt;&#x27;.__(&#x27;Title&#x27;, &#x27;carrington-build&#x27;).&#x27;&lt;/legend&gt;
          &lt;span class=&quot;cfct-input-full&quot;&gt;
            &lt;input type=&quot;text&quot; name=&quot;&#x27;.$this-&gt;get_field_id(&#x27;title&#x27;).&#x27;&quot; id=&quot;&#x27;.$this-&gt;get_field_id(&#x27;title&#x27;).&#x27;&quot; value=&quot;&#x27;.esc_attr(isset($data[$this-&gt;get_field_name(&#x27;title&#x27;)]) ? $data[$this-&gt;get_field_name(&#x27;title&#x27;)] : &#x27;&#x27;).&#x27;&quot; /&gt;
          &lt;/span&gt;
          &lt;!-- /title --&gt;
        &lt;/fieldset&gt;&#x27;;
    }

    /**
     * Show module post types filter
     * If only 1 post type is available the method ouputs a hidden
     * element instead of a select list
     *
     * @param array $data - saved module data
     * @return string HTML
     */
    public function admin_form_post_types($data) {
      $post_types = $this-&gt;get_post_types(null);
      $selected = (!empty($data[$this-&gt;gfn(&#x27;post_type&#x27;)]) ? $data[$this-&gt;gfn(&#x27;post_type&#x27;)] : array());

      $_taxes = apply_filters(self::TAXONOMY_TYPES_FILTER, get_object_taxonomies(array_keys($post_types), &#x27;objects&#x27;), $this);
      foreach ($_taxes as $taxonomy) {
        if ($taxonomy-&gt;name == &#x27;post_format&#x27;) {
          // its like a cockroach...
          continue;
        }
        $tax_defs[$taxonomy-&gt;name] = $taxonomy-&gt;label;
      }
      
      $html = &#x27;
      &lt;fieldset class=&quot;cfct-form-section&quot; id=&quot;&#x27;.$this-&gt;gfi(&#x27;post_type_checks&#x27;).&#x27;&quot;&gt;
        &lt;legend&gt;Post Type&lt;/legend&gt;&#x27;;
      if (count($post_types) &gt; 1) {
        $html .= &#x27;
          &lt;div class=&quot;cfct-columnized cfct-columnized-4x clearfix&quot;&gt;
            &lt;ul&gt;&#x27;;
          foreach ($post_types as $key =&gt; $post_type) {
            $post_taxonomies = $this-&gt;get_post_type_taxonomies($key);
            $html .= &#x27;
              &lt;li&gt;
                &lt;input type=&quot;checkbox&quot; name=&quot;&#x27;.$this-&gt;gfn(&#x27;post_type&#x27;).&#x27;[]&quot; id=&quot;&#x27;.$this-&gt;gfi(&#x27;post-type-&#x27;.$key).&#x27;&quot; &#x27;;
            if (is_array($selected) &amp;&amp; in_array($key, $selected)) {
              $html .= &#x27;checked=&quot;checked&quot; &#x27;;
            }    
            $html .= &#x27;class=&quot;post-type-select&quot; data-taxonomies=&quot;&#x27;.implode(&#x27;,&#x27;, $post_taxonomies).&#x27;&quot; value=&quot;&#x27;.$key.&#x27;&quot; /&gt;
                &lt;label for=&quot;&#x27;.$this-&gt;gfi(&#x27;post-type-&#x27;.$key).&#x27;&quot;&gt;&#x27;.$post_type-&gt;labels-&gt;name.&#x27;&lt;/label&gt;
              &lt;/li&gt;&#x27;;
          }  
          $html .= &#x27;
            &lt;/ul&gt;
          &lt;/div&gt;&#x27;;
      }
      elseif (count($post_types) == 1) {
        // if we only have one option then just set a hidden element
        $key = key($post_types);
        $post_type = current($post_types);
        $post_taxonomies = $this-&gt;get_post_type_taxonomies($key);
        $html .= &#x27;
          &lt;input type=&quot;hidden&quot; class=&quot;post-type-select&quot; name=&quot;&#x27;.$this-&gt;get_field_name(&#x27;post_type&#x27;).&#x27;[]&quot; value=&quot;&#x27;.$key.&#x27;&quot; data-taxonomies=&quot;&#x27;.implode(&#x27;,&#x27;, $post_taxonomies).&#x27;&quot; /&gt;&#x27;;
      }
      elseif (empty($post_types)) {
        $type = get_post_type($this-&gt;default_post_type);
        $post_taxonomies = $this-&gt;get_post_type_taxonomies($type-&gt;name);
        $html .= &#x27;
          &lt;input type=&quot;hidden&quot; class=&quot;post-type-select&quot; name=&quot;&#x27;.$this-&gt;gfn(&#x27;post_type&#x27;).&#x27;[]&quot; value=&quot;&#x27;.$post_type-&gt;name.&#x27;&quot; data-taxonomies=&quot;&#x27;.implode(&#x27;,&#x27;, $post_taxonomies).&#x27;&quot; /&gt;&#x27;;
      }
      
      $html .= &#x27;          
          &lt;input type=&quot;hidden&quot; name=&quot;&#x27;.$this-&gt;gfn(&#x27;tax_defs&#x27;).&#x27;&quot; id=&quot;&#x27;.$this-&gt;gfi(&#x27;tax_defs&#x27;).&#x27;&quot; disabled=&quot;disabled&quot; value=\&#x27;&#x27;.json_encode($tax_defs).&#x27;\&#x27; /&gt;
        &lt;/fieldset&gt;&#x27;;
        
      return $html;
    }
    
    protected function get_post_type_taxonomies($post_type) {
      $taxonomies = get_object_taxonomies($post_type);
      foreach($taxonomies as $i =&gt; $t) {
        if ($t == &#x27;post_format&#x27;) {
          // cockroach!
          unset($taxonomies[$i]);
        }
      }
      return $taxonomies;
    }

    /**
     * Show module taxonomy filter options
     *
     * @param array $data - saved module data
     * @return string HTML
     */
    public function admin_form_taxonomy_filter($data) {
      $html = &#x27;&#x27;;
      
      $post_type = ($data[$this-&gt;get_field_name(&#x27;post_type&#x27;)]) ? $data[$this-&gt;get_field_name(&#x27;post_type&#x27;)] : $this-&gt;default_post_type;
      $_taxes = apply_filters(self::TAXONOMY_TYPES_FILTER, get_object_taxonomies($post_type, &#x27;objects&#x27;), $this);
      
      $tax_defs = array();
      foreach ($_taxes as $tax_type =&gt; $taxonomy) {
        if ($tax_type == &#x27;post_format&#x27;) { 
          continue;
        }
        if (!is_array($post_type)) {
          $post_type = array($post_type);
        }
        $matches = array_intersect($post_type, $taxonomy-&gt;object_type);
        if (count($matches) == count($post_type)) {
          $taxes[$tax_type] = $taxonomy;
        }
      }
      unset($_taxes);

      $html = &#x27;
        &lt;fieldset class=&quot;cfct-form-section&quot;&gt;
          &lt;script type=&quot;text/javascript&quot;&gt;
            // you will not see this in the DOM, it gets parsed right away at ajax load
            var tax_defs = &#x27;.json_encode($tax_defs).&#x27;;
          &lt;/script&gt;
          &lt;legend&gt;&#x27;.__(&#x27;Taxonomies&#x27;, &#x27;carrington-build&#x27;).&#x27;&lt;/legend&gt;
          &lt;!-- taxonomy select --&gt;
          &lt;div class=&quot;&#x27;.$this-&gt;id_base.&#x27;-input-wrapper &#x27;.$this-&gt;id_base.&#x27;-post-category-select &#x27;.$this-&gt;id_base.&#x27;-tax-wrapper&quot;&gt;
            &lt;div id=&quot;&#x27;.$this-&gt;gfi(&#x27;tax-select-inputs&#x27;).&#x27;&quot; class=&quot;cfct-inline-els&quot;&gt;
              &#x27;.$this-&gt;get_taxonomy_dropdown($taxes, $data).&#x27;
              &lt;button id=&quot;&#x27;.$this-&gt;id_base.&#x27;-add-tax-button&quot; class=&quot;button&quot; type=&quot;button&quot;&gt;&#x27;.__(&#x27;Add Filter&#x27;, &#x27;carrington-build&#x27;).&#x27;&lt;/button&gt;
              &lt;span class=&quot;&#x27;.$this-&gt;id_base.&#x27;-loading cfct-spinner&quot; style=&quot;display: none;&quot;&gt;Loading&amp;hellip;&lt;/span&gt;
            &lt;/div&gt;
            &lt;div id=&quot;&#x27;.$this-&gt;id_base.&#x27;-tax-filter-items&quot; class=&quot;cfct-module-admin-repeater-block&quot;&gt;
              &lt;ol class=&quot;&#x27;.(empty($data[$this-&gt;gfn(&#x27;tax_input&#x27;)]) ? &#x27; no-items&#x27; : &#x27;&#x27;).&#x27;&quot;&gt;&#x27;;
      $html .= $this-&gt;get_taxonomy_filter_items($data);
      $html .= &#x27;
              &lt;/ol&gt;
            &lt;/div&gt;
          &lt;/div&gt;
          &#x27;.$this-&gt;get_filter_advanced_options($data).&#x27;
          &lt;!-- /taxonomy select --&gt;
        &lt;/fieldset&gt;
        &lt;fieldset class=&quot;cfct-form-section&quot;&gt;
          &lt;legend&gt;&#x27;.__(&#x27;Author&#x27;, &#x27;carrington-build&#x27;).&#x27;&lt;/legend&gt;
          &lt;!-- author select --&gt;
          &lt;div class=&quot;cfct-inline-els&quot;&gt;
            &#x27;.$this-&gt;get_author_dropdown($data).&#x27;
          &lt;/div&gt;
          &lt;!-- /author select --&gt;
        &lt;/fieldset&gt;&#x27;;
      return $html;
    }
    
    protected function get_filter_advanced_options($data) {
      $html = &#x27;
        &lt;div id=&quot;&#x27;.$this-&gt;gfi(&#x27;filter-advanced-options&#x27;).&#x27;&quot;&gt;
          &lt;p&gt;&lt;a class=&quot;toggle &#x27;.$this-&gt;gfi(&#x27;advanced-filter-options-toggle&#x27;).&#x27;&quot; id=&quot;advanced-filter-options-toggle&quot; href=&quot;#&#x27;.$this-&gt;gfi(&#x27;filter-advanced-options-container&#x27;).&#x27;&quot;&gt;&#x27;.
            sprintf(__(&#x27;%sShow%s Advanced Options&#x27;, &#x27;carrington-build&#x27;), &#x27;&lt;span&gt;&#x27;, &#x27;&lt;/span&gt;&#x27;).&#x27;&lt;/a&gt;&lt;/p&gt;
          &lt;div id=&quot;&#x27;.$this-&gt;gfi(&#x27;filter-advanced-options-container&#x27;).&#x27;&quot; style=&quot;display: none;&quot;&gt;
            &#x27;.$this-&gt;get_filter_relation_select($data).&#x27;
          &lt;/div&gt;
        &lt;/div&gt;&#x27;;
      return $html;
    }
    
    /**
     * Taxonomy query relation
     * 
     * By default all queries are done with an AND operator, meaning that all taxonomies
     * selected must be part of the result. Change this to &#x27;OR&#x27; and then all results must
     * match at least 1 of the selected taxonomies instead of all of them
     *
     * @param array $data 
     * @return void
     */
    protected function get_filter_relation_select($data) {
      $relations = apply_filters($this-&gt;id_base.&#x27;-relation-options&#x27;, array(
        &#x27;AND&#x27; =&gt; __(&#x27;And - all taxonomies must be matched&#x27;, &#x27;carrington-build&#x27;),
        &#x27;OR&#x27; =&gt; __(&#x27;Or - any taxonomy can be matched&#x27;, &#x27;carrington-build&#x27;)
      ));
      
      $selected = $this-&gt;get_data(&#x27;relation&#x27;, $data, $this-&gt;default_relation);
      
      $html = &#x27;
        &lt;div class=&quot;cfct-inline-els&quot;&gt;
          &lt;label for=&quot;&#x27;.$this-&gt;gfi(&#x27;relation&#x27;).&#x27;&quot;&gt;&#x27;.__(&#x27;Filter Relation&#x27;, &#x27;carrington-build&#x27;).&#x27;&lt;/label&gt;
          &lt;select name=&quot;&#x27;.$this-&gt;gfn(&#x27;relation&#x27;).&#x27;&quot; id=&quot;&#x27;.$this-&gt;gfi(&#x27;relation&#x27;).&#x27;&quot;&gt;&#x27;;
      foreach ($relations as $key =&gt; $relation) {
        $html .= &#x27;
            &lt;option value=&quot;&#x27;.$key.&#x27;&quot;&#x27;.selected($key, $selected, false).&#x27;&gt;&#x27;.$relation.&#x27;&lt;/option&gt;&#x27;;
      }
      $html .= &#x27;
          &lt;/select&gt;
        &lt;/div&gt;&#x27;;
      return $html;
    }

    /**
     * Show module output display options
     *
     * @param array $data - saved module data
     * @return string HTML
     */
    public function admin_form_display_options($data) {
      return &#x27;
        &lt;fieldset class=&quot;cfct-form-section&quot;&gt;
          &lt;legend&gt;&#x27;.__(&#x27;Display&#x27;, &#x27;carrington-build&#x27;).&#x27;&lt;/legend&gt;
          &lt;div class=&quot;&#x27;.$this-&gt;id_base.&#x27;-display-group-left&quot;&gt;
            &lt;!-- display type --&gt;
            &lt;div class=&quot;cfct-inline-els&quot;&gt;
              &#x27;.$this-&gt;get_display_type($data).&#x27;
            &lt;/div&gt;
            &lt;!-- / display type --&gt;

            &lt;!-- num posts input --&gt;
            &#x27;.$this-&gt;get_item_count_input($data).&#x27;
            &lt;!-- / num posts input --&gt;

            &lt;!-- num posts input --&gt;
            &#x27;.$this-&gt;get_item_count_offset_input($data).&#x27;
            &lt;!-- / num posts input --&gt;
          &lt;/div&gt;
          &lt;!-- pagination --&gt;
          &lt;div class=&quot;&#x27;.$this-&gt;id_base.&#x27;-display-group-right&quot;&gt;
            &#x27;.$this-&gt;get_pagination_section($data).&#x27;
          &lt;/div&gt;
          &lt;!-- /pagination --&gt;
        &lt;/fieldset&gt;&#x27;;
    }
    
    protected function get_item_count_input($data) {
      return &#x27;
        &lt;div class=&quot;cfct-inline-els&quot;&gt;
          &lt;label for=&quot;&#x27;.$this-&gt;get_field_id(&#x27;item_count&#x27;).&#x27;&quot;&gt;&#x27;.__(&#x27;Number of Items:&#x27;, &#x27;carrington-build&#x27;).&#x27;&lt;/label&gt;
          &lt;input class=&quot;cfct-number-field&quot; id=&quot;&#x27;.$this-&gt;get_field_id(&#x27;item_count&#x27;).&#x27;&quot; name=&quot;&#x27;.$this-&gt;get_field_name(&#x27;item_count&#x27;).&#x27;&quot; type=&quot;text&quot; value=&quot;&#x27;.esc_attr($this-&gt;get_data(&#x27;item_count&#x27;, $data, $this-&gt;default_item_count)).&#x27;&quot; /&gt;
        &lt;/div&gt;&#x27;;
    }
    
    protected function get_item_count_offset_input($data) {
      return &#x27;
        &lt;div class=&quot;cfct-inline-els&quot;&gt;
          &lt;label for=&quot;&#x27;.$this-&gt;get_field_id(&#x27;item_offset&#x27;).&#x27;&quot;&gt;&#x27;.__(&#x27;Start at Item:&#x27;, &#x27;carrington-build&#x27;).&#x27;&lt;/label&gt;
          &lt;input class=&quot;cfct-number-field&quot; id=&quot;&#x27;.$this-&gt;get_field_id(&#x27;item_offset&#x27;).&#x27;&quot; name=&quot;&#x27;.$this-&gt;get_field_name(&#x27;item_offset&#x27;).&#x27;&quot; type=&quot;text&quot; value=&quot;&#x27;.esc_attr($this-&gt;get_data(&#x27;item_offset&#x27;, $data, $this-&gt;default_item_offset)).&#x27;&quot; /&gt;
        &lt;/div&gt;&#x27;;
    }

# Admin helpers

    /**
     * Get the display type select list
     *
     * @param array $data
     * @return string HTML
     */
    protected function get_display_type($data) {
      $value = $this-&gt;get_data(&#x27;display_type&#x27;, $data, $this-&gt;default_content_display);
      if(empty($this-&gt;content_display_options[$value])) {
        $value = $this-&gt;default_content_display;
      }

      if(count($this-&gt;content_display_options) &gt; 1) {
        $args = array(
          &#x27;label&#x27; =&gt; __(&#x27;Show&#x27;, &#x27;carrington-build&#x27;),
          &#x27;default&#x27; =&gt; (!empty($data[$this-&gt;get_field_name(&#x27;display_type&#x27;)]) ? $data[$this-&gt;get_field_name(&#x27;display_type&#x27;)] : null)
        );
        return $this-&gt;dropdown(&#x27;display_type&#x27;, $this-&gt;content_display_options, $value, $args);
      }
      else {
        // i.e., subclass only allows one content display type
        return &#x27;
          &lt;input type=&quot;hidden&quot; name=&quot;&#x27;.$this-&gt;get_field_name(&#x27;display_type&#x27;).&#x27;&quot; id=&quot;&#x27;.$this-&gt;get_field_id(&#x27;display_type&#x27;).&#x27;&quot; value=&quot;&#x27;.$value.&#x27;&quot;/&gt;&#x27;;
      }
    }
    
    protected function get_taxonomy_filter_items($data) {
      $html = &#x27;&#x27;;
      
      if (!empty($data[$this-&gt;gfn(&#x27;tax_input&#x27;)])) {
        foreach ($data[$this-&gt;gfn(&#x27;tax_input&#x27;)] as $taxonomy =&gt; $tax_input) {
          $html .= $this-&gt;get_taxonomy_filter_item($taxonomy, $tax_input);
        }
      }
      
      $html .= &#x27;
        &lt;li class=&quot;cfct-repeater-item no-items-item&quot;&gt;
          &lt;p&gt;&#x27;.__(&#x27;There are currently no taxonomy filters.&#x27;, &#x27;carrington-build&#x27;).&#x27;&lt;/p&gt;
        &lt;/li&gt;&#x27;;
      return $html;
    }
    
    protected function get_taxonomy_filter_item($taxonomy, $tax_input) {
      if (!is_object($taxonomy)) {
        $taxonomy = get_taxonomy($taxonomy);
      }
      
      $html = &#x27;
        &lt;li id=&quot;&#x27;.$this-&gt;id_base.&#x27;-tax-section-&#x27;.$taxonomy-&gt;name.&#x27;&quot; class=&quot;&#x27;.$this-&gt;id_base.&#x27;-tax-section cfct-repeater-item&quot; data-taxonomy=&quot;&#x27;.$taxonomy-&gt;name.&#x27;&quot;&gt;&#x27;;
      
      // Heirarchichal taxonomy checkbox interface
      if ($taxonomy-&gt;hierarchical) {
        $html .= &#x27;
            &lt;h2 class=&quot;cfct-title&quot;&gt;&#x27;.$taxonomy-&gt;label.&#x27;:  &lt;/h2&gt;&#x27;;
        $html .= $this-&gt;get_taxonomy_selector(array(
          &#x27;taxonomy&#x27; =&gt; $taxonomy,
          &#x27;selected_cats&#x27; =&gt; (!empty($tax_input) ? $tax_input : array()),
          &#x27;post_id&#x27; =&gt; $this-&gt;get_post_id()
        ));
      }
      // Tag type-ahead search input
      else {
        if (!empty($tax_input)) {
          foreach ($tax_input as &amp;$term) {
            $_term = get_term($term, $taxonomy-&gt;name);
            $term = $_term-&gt;name;
          }
        }
        $html .= &#x27;
            &lt;label class=&quot;cfct-title&quot; for=&quot;&#x27;.$this-&gt;gfi(&#x27;tax-filter-&#x27;.$taxonomy-&gt;name).&#x27;&quot;&gt;&#x27; . $taxonomy-&gt;label . &#x27;&lt;/label&gt;

            &lt;div class=&quot;cfct-tax-filter-type-ahead-wrapper&quot;&gt;
              &lt;span class=&quot;cfct-input-full&quot;&gt;
                &lt;input class=&quot;&#x27;.$this-&gt;id_base.&#x27;-tax-filter-type-ahead-search&quot; name=&quot;tax_input[&#x27;.$taxonomy-&gt;name.&#x27;]&quot; id=&quot;&#x27;.$this-&gt;gfi(&#x27;tax-input-&#x27;.$taxonomy-&gt;name).&#x27;&quot; type=&quot;text&quot; value=&quot;&#x27;.(!empty($tax_input) ? implode(&#x27;, &#x27;, $tax_input) : &#x27;&#x27;).&#x27;&quot; /&gt;
              &lt;/span&gt;
              &lt;div class=&quot;cfct-help&quot;&gt;&#x27;.__(&#x27;Start typing to search for a term. Separate terms with commas. If a term is misspelled (ie: does not exist) it will be discarded during save.&#x27;, &#x27;carrington-build&#x27;).&#x27;&lt;/div&gt;
            &lt;/div&gt;&#x27;;
      }
      $html .= &#x27;
          &lt;div class=&quot;warning-text&quot;&gt;
            &lt;p&gt;&#x27;.__(&#x27;This taxonomy is incompatible with the current post-type selection and will be discarded upon save. Change the post-type selection to keep this filter.&#x27;, &#x27;carrington-build&#x27;).&#x27;&lt;/p&gt;
          &lt;/div&gt;
          &lt;a href=&quot;#&quot; class=&quot;cfct-repeater-item-remove&quot;&gt;remove&lt;/a&gt;
        &lt;/li&gt;&#x27;;
      
      return $html;
    }
    
    /**
     * Returns a dropdown for available taxonomies
     *
     * @param array $items array of taxonomy objects
     * @return string
     */
    protected function get_taxonomy_dropdown($items, $data) {
      // Prepare our options
      $options = array();
      if (!empty($items)) {
        foreach ($items as $k =&gt; $v) {
          if (in_array($k, array(&#x27;link_category&#x27;, &#x27;nav_menu&#x27;))) {
            continue;
          }
          $options[$k] = $v-&gt;labels-&gt;name;
        }
      }
      
      //print_r($data);
      $index = &quot;&quot;; // TODO: What is $index supposed to be here?  Setting it blank.
      $field_name = $this-&gt;get_field_name(&#x27;taxonomy-&#x27;.$index);
      $value = (isset($data[$field_name])) ? $data[$field_name] : 0;
      
      $html = $this-&gt;dropdown(
        &#x27;taxonomy-select&#x27;,
        $options,
        $value,
        array(
          &#x27;default&#x27; =&gt; array(
            &#x27;value&#x27; =&gt; &#x27;&#x27;,
            &#x27;text&#x27; =&gt; __($this-&gt;default_tax_select_text, &#x27;carrington-build&#x27;),
          ),
          &#x27;class_name&#x27; =&gt; &#x27;taxonomy&#x27;
        )
      );
    
      return $html;
    }

    /**
     * Get a list of post types available for selection
     * Automatically excludes attachments, revisions, and nav_menu_items
     * Post Type must be public to appear in this list
     *
     * @param string $type - &#x27;post&#x27; for non-heirarchal objects, &#x27;page&#x27; or heirarchal objects
     * @return array
     */
    protected function get_post_types($type) {
      $type_opts = array(
        &#x27;publicly_queryable&#x27; =&gt; 1
      );
      if (!empty($type)) {
        if(is_array($type)) {
          $hierarchical = true;
          if((count($type) == 1) &amp;&amp; ($type[0] == &#x27;post&#x27;)) {
            $hierarchical = false;
          }
        }
        else {
          $hierarchical = ($type == &#x27;post&#x27; ? false : true);
        }
        $type_opts[&#x27;hierarchical&#x27;] = $hierarchical;
      }
      $post_types = get_post_types($type_opts, &#x27;objects&#x27;);
      ksort($post_types);
      
      // be safe, filter out the undesirables
      foreach (array(&#x27;attachment&#x27;, &#x27;revision&#x27;, &#x27;nav_menu_item&#x27;) as $item) {
        if (!empty($post_types[$item])) {
          unset($post_types[$item]);
        }
      }
      
      return apply_filters(self::POST_TYPES_FILTER, $post_types, $this);
    }

    /**
     * Pagination selection items
     *
     * @param array $data - module save data
     * @return string HTML
     */
    protected function get_pagination_section($data) {
      $checkbox_value = (!empty($data[$this-&gt;get_field_name(&#x27;show_pagination&#x27;)])) ? $data[$this-&gt;get_field_name(&#x27;show_pagination&#x27;)] : &#x27;&#x27;;
      $url_value = (!empty($data[$this-&gt;get_field_name(&#x27;next_pagination_link&#x27;)])) ? $data[$this-&gt;get_field_name(&#x27;next_pagination_link&#x27;)] : &#x27;&#x27;;
      $text_value = (!empty($data[$this-&gt;get_field_name(&#x27;next_pagination_text&#x27;)])) ? $data[$this-&gt;get_field_name(&#x27;next_pagination_text&#x27;)] : &#x27;&#x27;;
      
      $html = &#x27;
        &lt;div class=&quot;cfct-inline-els&quot;&gt;
          &lt;label for=&quot;&#x27;.$this-&gt;get_field_id(&#x27;show_pagination&#x27;).&#x27;&quot;&gt;&#x27;.__(&#x27;Pagination Link&#x27;, &#x27;carrington-build&#x27;).&#x27;&lt;/label&gt;
          &lt;input type=&quot;checkbox&quot; name=&quot;&#x27;.$this-&gt;get_field_name(&#x27;show_pagination&#x27;).&#x27;&quot; id=&quot;&#x27;.$this-&gt;get_field_name(&#x27;show_pagination&#x27;).&#x27;&quot; value=&quot;yes&quot;&#x27;.checked(&#x27;yes&#x27;, $checkbox_value, false).&#x27; /&gt;
        &lt;/div&gt;
        &lt;div id=&quot;pagination-wrapper&quot;&gt;
          &lt;div class=&quot;cfct-inline-els&quot;&gt;
            &lt;label for=&quot;&#x27;.$this-&gt;get_field_id(&#x27;next_pagination_link&#x27;).&#x27;&quot;&gt;&#x27;.__(&#x27;Link URL&#x27;, &#x27;carrington-build&#x27;).&#x27;&lt;/label&gt;
            &lt;input type=&quot;text&quot; name=&quot;&#x27;.$this-&gt;get_field_name(&#x27;next_pagination_link&#x27;).&#x27;&quot; id=&quot;&#x27;.$this-&gt;get_field_id(&#x27;next_pagination_link&#x27;).&#x27;&quot; value=&quot;&#x27;.$url_value.&#x27;&quot; /&gt;
          &lt;/div&gt;
          &lt;div class=&quot;cfct-inline-els&quot;&gt;
            &lt;label for=&quot;&#x27;.$this-&gt;get_field_id(&#x27;next_pagination_text&#x27;).&#x27;&quot;&gt;&#x27;.__(&#x27;Link Text&#x27;, &#x27;carrington-build&#x27;).&#x27;&lt;/label&gt;
            &lt;input type=&quot;text&quot; name=&quot;&#x27;.$this-&gt;get_field_name(&#x27;next_pagination_text&#x27;).&#x27;&quot; id=&quot;&#x27;.$this-&gt;get_field_id(&#x27;next_pagination_text&#x27;).&#x27;&quot; value=&quot;&#x27;.$text_value.&#x27;&quot; /&gt;
          &lt;/div&gt;
        &lt;/div&gt;&#x27;;
        
      return $html;
    }
        
// Required

    /**
     * Don&#x27;t contribute to the post_content stored in the database
     *
     * @return null
     */
    public function text() {
      return null;
    }

    public function admin_text($data) {
      return strip_tags($data[$this-&gt;get_field_name(&#x27;title&#x27;)]);
    }

    public function update($new_data,$old_data) {
      // Set default for item count
      $count =  $new_data[$this-&gt;gfi(&#x27;item_count&#x27;)];
      if (empty($count) &amp;&amp; $count !== &#x27;0&#x27;) {
        $new_data[$this-&gt;gfi(&#x27;item_count&#x27;)] = 10;
      }

      // Using wordpress constructs can give us a stand-alone post_category
      // input. Shoehorn it in to our own data structure for consistency
      if (!empty($new_data[&#x27;post_category&#x27;])) {
        $new_data[&#x27;tax_input&#x27;][&#x27;category&#x27;] = $new_data[&#x27;post_category&#x27;];
        unset($new_data[&#x27;post_category&#x27;]);
      }
      
      // Namespace the saved data &amp; convert non-hierarchical term strings in to arrays
      if (!empty($new_data[&#x27;tax_input&#x27;])) {
        foreach ($new_data[&#x27;tax_input&#x27;] as $taxonomy =&gt; $tax_input) {
          if (!is_array($tax_input)) {
            $tax_input = array_filter(array_map(&#x27;trim&#x27;, explode(&#x27;,&#x27;, $tax_input)));
            foreach ($tax_input as &amp;$tax_input_item) {
              $term = get_term_by(&#x27;name&#x27;, $tax_input_item, $taxonomy); {
                if (!empty($term) &amp;&amp; !is_wp_error($term)) {
                  $tax_input_item = $term-&gt;term_id;
                }
              }
            }
          }
          $new_data[$this-&gt;gfn(&#x27;tax_input&#x27;)][$taxonomy] = $tax_input;
        }
        unset($new_data[&#x27;tax_input&#x27;]);
      }
      
      return $new_data;
    }

    public function admin_css() {
      return preg_replace(&#x27;/(\t){4}/m&#x27;, &#x27;&#x27;, &#x27;
        #&#x27;.$this-&gt;id_base.&#x27;-admin-form-wrapper li .warning-text {
          border: 1px solid #822c27;
          background-color: #990000;
          -moz-border-radius: 3px;
          -webkit-border-radius: 3px;
          -khtml-border-radius: 3px;
          border-radius: 3px;
          display: none;
          margin-bottom: 5px;
          padding: 6px;
        }
        #&#x27;.$this-&gt;id_base.&#x27;-admin-form-wrapper li .warning-text p {
          color: #fff;
          font-size: 11px;
          line-height: 15px;
          margin: 0;
        }
        #&#x27;.$this-&gt;id_base.&#x27;-admin-form-wrapper li.post-type-taxonomy-warning {
          background-color: #fcf2f2;
          color: #666;
        }
        #&#x27;.$this-&gt;id_base.&#x27;-admin-form-wrapper li.post-type-taxonomy-warning .cfct-input-full,
        #&#x27;.$this-&gt;id_base.&#x27;-admin-form-wrapper li.post-type-taxonomy-warning input[type=text] {
          background: #eee;
        }
        
        #&#x27;.$this-&gt;id_base.&#x27;-admin-form-wrapper li.post-type-taxonomy-warning .warning-text {
          display: block;
        }
        #&#x27;.$this-&gt;id_base.&#x27;-admin-form-wrapper .cfct-repeater-item input[type=text] {
          width: 616px
        }
        .&#x27;.$this-&gt;gfi(&#x27;advanced-filter-options-toggle&#x27;).&#x27; {
          font-size: .9em;
        }
      &#x27;);
    }

    public function admin_js() {
      $this-&gt;js_base = str_replace(&#x27;-&#x27;, &#x27;_&#x27;, $this-&gt;id_base);
      return preg_replace(&#x27;/^(\t){4}/m&#x27;, &#x27;&#x27;, &#x27;
        cfct_builder.addModuleLoadCallback(&quot;&#x27;.$this-&gt;id_base.&#x27;&quot;, function(form) {
          
          &#x27;.$this-&gt;js_base.&#x27;_get_selected_post_type_taxonomies = function() {
            var taxonomies = null;
            // merge available taxonomies from the chosen post types
            $(&quot;:input.post-type-select:checked, input[type=hidden].post-type-select&quot;).each(function() {
              var _taxes = $(this).attr(&quot;data-taxonomies&quot;).split(&quot;,&quot;);
              if (taxonomies == null) {
                taxonomies = _taxes;
              }
              else {
                taxonomies = cfct_array_intersect(taxonomies, _taxes);
              }
            })
            return taxonomies;
          }
          
          // do post-type selection change        
          $(&quot;#&#x27;.$this-&gt;gfi(&#x27;post_type_checks&#x27;).&#x27; :input.post-type-select&quot;, form).change(function() {
            &#x27;.$this-&gt;js_base.&#x27;_filter_taxonomy_select();
          });
          
          // add another taxonomy block
          $(&quot;#&#x27;.$this-&gt;id_base.&#x27;-add-tax-button&quot;).click(function() {
            var _this = $(this);
            var tax = $(&quot;#&#x27;.$this-&gt;id_base.&#x27;-taxonomy-select&quot;, form).val();
            if ( tax != &quot;none&quot;) {
               &#x27;.$this-&gt;js_base.&#x27;_set_loading();
              cfct_builder.fetch(
                &quot;&#x27;.$this-&gt;id_base.&#x27;-get-new-taxonomy-block&quot;, 
                {
                  taxonomy: tax,
                  post_types: $(&quot;#&#x27;.$this-&gt;id_base.&#x27;-post_type&quot;, form).val()
                },
                null,
                null,
                &#x27;.$this-&gt;js_base.&#x27;_insert_taxonomy_block
              );
            }
            return false;
          });
          
          &#x27;.$this-&gt;js_base.&#x27;_filter_taxonomy_select = function() {
            var taxonomies = &#x27;.$this-&gt;js_base.&#x27;_get_selected_post_type_taxonomies();
            var tax_names = eval(&quot;(&quot; + $(&quot;#&#x27;.$this-&gt;gfi(&#x27;tax_defs&#x27;).&#x27;&quot;).val() + &quot;)&quot;);
            var _tgt = $(&quot;#&#x27;.$this-&gt;id_base.&#x27;-taxonomy-select&quot;, form);
            var options = &quot;&quot;;
                        
            // create options for the taxonomoy select list
            if (taxonomies != null &amp;&amp; taxonomies.length &gt; 0) {
              options = &quot;&lt;option value=\&quot;none\&quot;&gt;&#x27;.__($this-&gt;default_tax_select_text, &#x27;carrington-build&#x27;).&#x27;&lt;/option&gt;&quot;;              
              for (i = 0; i &lt; taxonomies.length; i++) {
                options += &quot;&lt;option value=\&quot;&quot; + taxonomies[i] + &quot;\&quot;&gt;&quot; + tax_names[taxonomies[i]] + &quot;&lt;/option&gt;&quot;;
              }
            }
            else {
              options = &quot;&lt;option value=\&quot;none\&quot;&gt;&#x27;.__(&#x27;no matching taxonomies available&#x27;, &#x27;carrington-build&#x27;).&#x27;&lt;/option&gt;&quot;;
            }
            
            // assign new options to the taxonomy select list
            _tgt.html(options);
            &#x27;.$this-&gt;js_base.&#x27;_prep_taxonomy_filter_list();
          }
          
          // generic repeater element remove button
          $(&quot;.cfct-module-admin-repeater-block .cfct-repeater-item .cfct-repeater-item-remove&quot;).live(&quot;click&quot;, function() {
            var _list = $(this).closest(&quot;ol&quot;);
            $(this).closest(&quot;li&quot;).remove();
            if (_list.find(&quot;li.cfct-repeater-item&quot;).size() == 1) {
              _list.addClass(&quot;no-items&quot;);
            }
            &#x27;.$this-&gt;js_base.&#x27;_filter_taxonomy_select();
            return false;
          });
                
          // taxonomy filter selection callback
          &#x27;.$this-&gt;js_base.&#x27;_insert_taxonomy_block = function(ret) {
            if (ret.success) {
              var _list = $(&quot;#&#x27;.$this-&gt;id_base.&#x27;-tax-filter-items ol&quot;, form);
              var _html = $(ret.html);    
              _list.prepend(_html);
              
              // columnize
              _html.find(&quot;ul.categorychecklist&quot;).columnizeLists({ cols: 3 });
              
              // set no-items status
              if (_list.find(&quot;li.cfct-repeater-item&quot;).size() &gt; 1) {
                _list.removeClass(&quot;no-items&quot;);
              }
              &#x27;.$this-&gt;js_base.&#x27;_unset_loading();
              &#x27;.$this-&gt;js_base.&#x27;_prep_taxonomy_filter_list();
            }
            else {
              // @TODO handle error
            }
          };
          
          // reset and prune the taxonomy filter list
          &#x27;.$this-&gt;js_base.&#x27;_prep_taxonomy_filter_list = function() {
            // prune the taxonomy filter list of taxonomies that are already being displayed
            $(&quot;#&#x27;.$this-&gt;id_base.&#x27;-taxonomy-select&quot;, form)
              .val(&quot;&quot;)
              .find(&quot;option&quot;)
              .each(function() {
                var _this = $(this);
                if (_this.attr(&quot;data-taxonomy&quot;) == &quot;&quot;) {
                  return;
                }
                
                if ( $(&quot;#&#x27;.$this-&gt;id_base.&#x27;-tax-filter-items li[data-taxonomy=&quot; + _this.val() + &quot;]&quot;).size() &gt; 0 ) {
                  _this.remove();
                }
              });
              
            var taxonomies = &#x27;.$this-&gt;js_base.&#x27;_get_selected_post_type_taxonomies();
            $(&quot;#&#x27;.$this-&gt;id_base.&#x27;-tax-filter-items ol li.cfct-repeater-item&quot;).not(&quot;.no-items-item&quot;).each(function() {
              var _this = $(this);
              var warning_class = &quot;post-type-taxonomy-warning&quot;;

              if ($.inArray(_this.attr(&quot;data-taxonomy&quot;), taxonomies) &gt; -1) {
                _this.removeClass(warning_class).find(&quot;:input&quot;).attr(&quot;disabled&quot;, false); // apparently more consistent than removeAttr()
                &#x27;.$this-&gt;js_base.&#x27;_bind_suggest(this);
              }
              else {
                _this.addClass(warning_class).find(&quot;:input&quot;).attr(&quot;disabled&quot;, &quot;disabled&quot;);
                &#x27;.$this-&gt;js_base.&#x27;_unbind_suggest(this);
              }
            });
          };
          
          &#x27;.$this-&gt;js_base.&#x27;_set_loading = function() {
            $(&quot;#&#x27;.$this-&gt;gfi(&#x27;tax-select-inputs&#x27;).&#x27; span.&#x27;.$this-&gt;gfi(&#x27;loading&#x27;).&#x27;&quot;).show();
          };
          
          &#x27;.$this-&gt;js_base.&#x27;_unset_loading = function() {
            $(&quot;#&#x27;.$this-&gt;gfi(&#x27;tax-select-inputs&#x27;).&#x27; span.&#x27;.$this-&gt;gfi(&#x27;loading&#x27;).&#x27;&quot;).hide();
          };          
          
          &#x27;.$this-&gt;js_base.&#x27;_bind_suggest = function(item) {
            var _parent = $(item);
            var e = _parent.find(&quot;.&#x27;.$this-&gt;id_base.&#x27;-tax-filter-type-ahead-search&quot;).unbind();

            // unattach any other suggests for this box
            $(&quot;.ac_results&quot;).remove();

            // hook our new suggest on there
            e.suggest(
              cfct_builder.opts.ajax_url + &quot;?action=cf_taxonomy_filter_autocomplete&amp;tax=&quot; + encodeURI(_parent.attr(&quot;data-taxonomy&quot;)),
              {
                delay: 500, 
                minchars: 2, 
                multiple: true,
                onSelect: function() {
                  $(this).attr(&quot;value&quot;, $(this).val());
                }
              }
            );
            $(&quot;.ac_results&quot;).css({&quot;z-index&quot;: &quot;10005&quot;});
          };
          
          &#x27;.$this-&gt;js_base.&#x27;_unbind_suggest = function(item) {
            $(item).find(&quot;.&#x27;.$this-&gt;id_base.&#x27;-tax-filter-type-ahead-search&quot;).unbind().end().find(&quot;.ac_results&quot;).remove();
          }
          
          // Show/Hide for Pagination
          $(&quot;#&#x27;.$this-&gt;get_field_id(&#x27;show_pagination&#x27;).&#x27;&quot;, form).change(function() {
            var _wrapper = $(&quot;#pagination-wrapper&quot;);
            if ($(this).is(&quot;:checked&quot;)) {
              _wrapper.show();
            }
            else {
              _wrapper.hide();
            }
          }).trigger(&quot;change&quot;);
          
          // columnize
          $(&quot;ul.categorychecklist&quot;, form).columnizeLists({ cols: 4 });
          
          // togglr
          $(&quot;.toggle&quot;, form).click(function() {
            var _tgt = $($(this).attr(&quot;href&quot;));
            if (_tgt.is(&quot;:visible&quot;)) {
              $(this).find(&quot;span&quot;).text(&quot;&#x27;.__(&#x27;Show&#x27;, &#x27;carrington-build&#x27;).&#x27;&quot;);
              _tgt.hide();
            }
            else {
              $(this).find(&quot;span&quot;).text(&quot;&#x27;.__(&#x27;Hide&#x27;, &#x27;carrington-build&#x27;).&#x27;&quot;);
              _tgt.show();
            }
            return false;
          });
          
          // do initial taxonomy select filtering
          &#x27;.$this-&gt;js_base.&#x27;_filter_taxonomy_select();
          &#x27;.$this-&gt;js_base.&#x27;_prep_taxonomy_filter_list();  
          $(&quot;.cfct-columnized-4x ul&quot;, form).columnizeLists({ cols: 4 });
          
        });
        
        cfct_builder.addModuleSaveCallback(&quot;&#x27;.$this-&gt;id_base.&#x27;&quot;,function(form) {
          // disable taxonomy filter dropdown so that it does not submit
          $(&quot;#&#x27;.$this-&gt;gfi(&#x27;taxonomy-select&#x27;).&#x27;&quot;).attr(&quot;disabled&quot;, &quot;disabled&quot;);
        });
      &#x27;);
    }
    
# Helpers

    /**
     * Load required script
     *
     * @return void
     */
    protected function enqueue_scripts() {
      global $pagenow;
      if (is_admin() &amp;&amp; in_array($pagenow, array(&#x27;post.php&#x27;, &#x27;edit.php&#x27;))) {
        wp_enqueue_script(&#x27;suggest&#x27;);
      }
    }

    /**
     * Prints HTML with meta information for the current post—date/time and author.  Thanks TwentyTen 1.0
     */
    protected function posted_on() {
      printf( __( &#x27;&lt;span class=&quot;%1$s&quot;&gt;Posted on&lt;/span&gt; %2$s &lt;span class=&quot;meta-sep&quot;&gt;by&lt;/span&gt; %3$s&#x27;, &#x27;carrington-build&#x27; ),
        &#x27;meta-prep meta-prep-author&#x27;,
        sprintf( &#x27;&lt;a href=&quot;%1$s&quot; title=&quot;%2$s&quot; rel=&quot;bookmark&quot;&gt;&lt;span class=&quot;entry-date&quot;&gt;%3$s&lt;/span&gt;&lt;/a&gt;&#x27;,
          get_permalink(),
          esc_attr( get_the_time() ),
          get_the_date()
        ),
        sprintf( &#x27;&lt;span class=&quot;author vcard&quot;&gt;&lt;a class=&quot;url fn n&quot; href=&quot;%1$s&quot; title=&quot;%2$s&quot;&gt;%3$s&lt;/a&gt;&lt;/span&gt;&#x27;,
          get_author_posts_url( get_the_author_meta( &#x27;ID&#x27; ) ),
          sprintf( esc_attr__( &#x27;View all posts by %s&#x27;, &#x27;carrington-build&#x27; ), get_the_author() ),
          get_the_author()
        )
      );
    }

    /**
     * Generates a simple dropdown
     *
     * @param string $field_name
     * @param array $options
     * @param int/string $value The current value of this field
     * @param array $args Miscellaneous arguments
     * @return string of &lt;select&gt; element&#x27;s HTML
     **/
    protected function dropdown($field_name, $options, $value = false, $args = &#x27;&#x27;) {
      $defaults = array(
        &#x27;label&#x27; =&gt; &#x27;&#x27;, // The text for the label element
        &#x27;default&#x27; =&gt; null, // Add a default option (&#x27;all&#x27;, &#x27;none&#x27;, etc.)
        &#x27;excludes&#x27; =&gt; array(), // values to exclude from options
        &#x27;class_name&#x27; =&gt; null, // name to use in the class; defaults to $field_name
        &#x27;multi&#x27; =&gt; false // use a multi-select instead of a single select
      );
      $args = array_merge($defaults, $args);
      extract($args);

      $options = (is_array($options)) ? $options : array();


      // Set a label if there is one
      $html = (!empty($label)) ? &#x27;&lt;label for=&quot;&#x27;.$this-&gt;gfi($field_name).&#x27;&quot;&gt;&#x27;.$label.&#x27;: &lt;/label&gt;&#x27; : &#x27;&#x27;;

      if(empty($class_name)) {
        $class_name = $field_name;
      }
      // Start off the select element
      $html .= &#x27;
        &lt;select class=&quot;&#x27;.$class_name.&#x27;-dropdown&quot; name=&quot;&#x27;.$this-&gt;gfn($field_name).($multi ? &#x27;[]&#x27; : &#x27;&#x27;).&#x27;&quot; id=&quot;&#x27;.$this-&gt;gfi($field_name).&#x27;&quot;&#x27;.($multi ? &#x27; multiple=&quot;multiple&quot;&#x27; : &#x27;&#x27;).&#x27;&gt;&#x27;;

      // Set a default option that&#x27;s not in the list of options (i.e., all, none)
      if (is_array($default)) {
        $html .= &#x27;&lt;option value=&quot;&#x27;.$default[&#x27;value&#x27;].&#x27;&quot;&#x27;.selected($default[&#x27;value&#x27;], $value, false).&#x27;&gt;&#x27;.esc_html($default[&#x27;text&#x27;]).&#x27;&lt;/option&gt;&#x27;;
      }

      // Loop through our options
      foreach ($options as $k =&gt; $v) {
        if (!in_array($k, $excludes)) {
          $selected = &#x27;&#x27;;
          if (is_array($value) &amp;&amp; in_array($k, $value)) {
            // the selected() helper doesn&#x27;t recognize arrays as potential values
            $selected = &#x27; selected=&quot;selected&quot;&#x27;;
          }
          elseif (!empty($value)) {
            $selected = selected($k, $value, false);
          }
          $html .= &#x27;&lt;option value=&quot;&#x27;.$k.&#x27;&quot;&#x27;.$selected.&#x27;&gt;&#x27;.esc_html($v).&#x27;&lt;/option&gt;&#x27;;
        }
      }

      // Close off our select element
      $html .= &#x27;
        &lt;/select&gt;&#x27;;
      return $html;
    }

// Content Move Helpers

    public function get_referenced_ids($data) {
      $referenced_ids = array();
      $data = $this-&gt;migrate_data($data);
      
      // author is allowed to be &quot;0&quot; in which case we don&#x27;t need to fuss
      if (!empty($data[$this-&gt;gfn(&#x27;author&#x27;)])) {
        $referenced_ids[&#x27;author&#x27;] = array(
          &#x27;type&#x27; =&gt; &#x27;user&#x27;,
          &#x27;type_name&#x27; =&gt; &#x27;user&#x27;,
          &#x27;value&#x27; =&gt; $data[$this-&gt;gfn(&#x27;author&#x27;)]
        );
      }
      
      if (!empty($data[$this-&gt;gfn(&#x27;tax_input&#x27;)])) {
        $referenced_ids[&#x27;tax_input&#x27;] = array();
        foreach ($data[$this-&gt;gfn(&#x27;tax_input&#x27;)] as $taxonomy =&gt; $term_ids) {
          if (!empty($term_ids)) {
            $referenced_ids[&#x27;tax_input&#x27;][$taxonomy] = array();
            foreach ($term_ids as $id) {
              $referenced_ids[&#x27;tax_input&#x27;][$taxonomy][] = array(
                &#x27;type&#x27; =&gt; &#x27;taxonomy&#x27;,
                &#x27;type_name&#x27; =&gt; $taxonomy,
                &#x27;value&#x27; =&gt; $id
              );
            }
          }
        }
      }

      return $referenced_ids;
    }
    
    public function merge_referenced_ids($data, $reference_data) {
      $data = $this-&gt;migrate_data($data);
            
      // author
      if (!empty($reference_data[&#x27;author&#x27;])) {
        $data[$this-&gt;gfn(&#x27;author&#x27;)] = $reference_data[&#x27;author&#x27;][&#x27;value&#x27;];
      }
      
      if (!empty($reference_data[&#x27;tax_input&#x27;])) {
        foreach ($reference_data[&#x27;tax_input&#x27;] as $tax_type =&gt; $term_ids) {
          $data[$this-&gt;gfn(&#x27;tax_input&#x27;)][$tax_type] = array();
          if (!empty($term_ids)) {
            foreach ($term_ids as $term) {
              $data[$this-&gt;gfn(&#x27;tax_input&#x27;)][$tax_type][] = $term[&#x27;value&#x27;];
            }
          }
        }
      }

      return $data;
    }
  }
  cfct_build_register_module(&#x27;cfct_module_loop&#x27;);
}
?&gt;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
