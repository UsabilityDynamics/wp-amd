<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/vendor/lib/ud_cloud.php - Flawless</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://a3d72a45d111006ec192-ec5b80a12b0b09b4d52373336afb4254.r80.cf1.rackcdn.com/usability-dynamics.png" title="Flawless"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/: Flawless.Element.html">: Flawless.Element</a></li>
            
                <li><a href="../classes/: Flawless.Flawless_Module.html">: Flawless.Flawless_Module</a></li>
            
                <li><a href="../classes/: Flawless.Flawless_Shortcode.html">: Flawless.Flawless_Shortcode</a></li>
            
                <li><a href="../classes/: Flawless.Flawless_Widget.html">: Flawless.Flawless_Widget</a></li>
            
                <li><a href="../classes/: Flawless.flawless_wpp_extensions.html">: Flawless.flawless_wpp_extensions</a></li>
            
                <li><a href="../classes/: Flawless.License.html">: Flawless.License</a></li>
            
                <li><a href="../classes/Shortcodes.html">Shortcodes</a></li>
            
                <li><a href="../classes/Template Functions.html">Template Functions</a></li>
            
                <li><a href="../classes/Template Methods.html">Template Methods</a></li>
            
                <li><a href="../classes/Theme UI.html">Theme UI</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Core Assets.html">Core Assets</a></li>
            
                <li><a href="../modules/Flawless.html">Flawless</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: core/vendor/lib/ud_cloud.php</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&lt;?php
if( !class_exists( &#x27;UD_Cloud&#x27; ) ) {

  /**
   * UD Cloud API
   * Establishes UD Cloud Connection and Pushes Objects as defined in Configuration on Update
   *
   * @version 1.1.2
   * @author potanin@UD
   * @package UD
   * @supackage UD_Cloud
   */
class UD_Cloud extends UD_Functions {

  static $version = &#x27;1.0.2&#x27;;
  static $client = &#x27;UD_Cloud/1.0.2&#x27;;
  static $defaults = &#x27;ud_cloud.config.json&#x27;;
  static $option = &#x27;ud_cloud&#x27;;
  static $url = &#x27;http://cloud.usabilitydynamics.com&#x27;;
  static $document_type = &#x27;default&#x27;;
  static $site_uid = false;
  static $public_key = false;
  static $api_key = false;
  static $customer_key = false;

  /**
   * Initializes Bridge by Adding Filters
   *
   * @since 1.0.0
   * @author potanin@UD
   */
  static function initialize( $args = array() ) {

    self::$site_uid = UD_SaaS::get_key( &#x27;site_uid&#x27; );
    self::$public_key = UD_SaaS::get_key( &#x27;public_key&#x27; );
    self::$customer_key = UD_SaaS::get_key( &#x27;customer_key&#x27; );
    self::$api_key = UD_SaaS::get_key( &#x27;api_key&#x27; );

    if( $args[ &#x27;post_types&#x27; ] ) {
      update_option( self::$option . &#x27;::post_types&#x27;, $args[ &#x27;post_types&#x27; ] );
    }

    add_filter( &#x27;save_post&#x27;, array( __CLASS__, &#x27;index&#x27; ), 100 );
    add_action( &#x27;post_submitbox_misc_actions&#x27;, array( __CLASS__, &#x27;post_submitbox_misc_actions&#x27; ) );
  }

  /**
   * Synchronized listings with Cloud Searching Service
   *
   * @todo Add extend() to args. - potanin@UD 10/08/12
   * @version 1.1
   * @since 2.0
   */
  static function index( $posts = false, $args = false ) {

    if( !defined( &#x27;UD_Site_UID&#x27; ) ) {
      return new WP_Error( __METHOD__, &#x27;Unable to index, Site UID not defined.&#x27; );
    }

    if( !$posts ) {
      return new WP_Error( __METHOD__, &#x27;Unable to index, no documents passed.&#x27; );
    }

    if( defined( &#x27;DOING_AUTOSAVE&#x27; ) &amp;&amp; DOING_AUTOSAVE ) {
      return $posts;
    }

    self::timer_start( __METHOD__ );

    if( ( is_object( $posts ) &amp;&amp; isset( $posts-&gt;ID ) ) || ( is_array( $posts ) &amp;&amp; isset( $posts[ &#x27;ID&#x27; ] ) ) ) {

      if( wp_is_post_revision( $posts ) ) {
        return null;
      }

      $posts = array( (object) $posts );
    }

    if( is_numeric( $posts ) ) {
      $posts = get_post( $posts );

      if( wp_is_post_revision( $posts ) ) {
        return null;
      }

      $posts = array( $posts );
    }

    //** Why json_decode - json_encode? */
    $posts = (array) json_decode( json_encode( $posts ) );

    $post_types = (array) get_option( self::$option . &#x27;::post_types&#x27; );

    //** Get post type from one of the posts */
    $current_type = &#x27;&#x27;;
    if ( count( $posts ) &amp;&amp; $posts[0]-&gt;post_type ) {
      $current_type = $posts[0]-&gt;post_type;
    }

    $args = $args ? $args : self::get_configuration( $current_type );

    foreach( (array) $posts as $count =&gt; $post ) {

      if( !isset( $document_type ) || !$document_type ) {
        $document_type = $post-&gt;post_type ? $post-&gt;post_type : self::$document_type;
      }

      if( !in_array( $post-&gt;post_type, $post_types ) ) {

        if( get_post_meta( $post-&gt;ID, &#x27;ud_cloud::synchronized&#x27;, true ) ) {
          self::delete( $post-&gt;ID, $post-&gt;post_type );
        }

        unset( $posts[ $count ] );
        continue;
      }

      $posts[ $count ]-&gt;_id = $post-&gt;id ? $post-&gt;id : $post-&gt;ID;

      foreach( (array) self::strip_protected_keys( (array) get_metadata( &#x27;post&#x27;, $post-&gt;ID ) ) as $meta_key =&gt; $values ) {
        $posts[ $count ]-&gt;{$meta_key} = array_shift( array_values( $values ) );
      }

      $posts[ $count ]-&gt;terms = $posts[ $count ]-&gt;terms ? $posts[ $count ]-&gt;terms : wp_get_object_terms( $post-&gt;ID, get_object_taxonomies( $post-&gt;post_type ) );
      $posts[ $count ]-&gt;comments = $posts[ $count ]-&gt;comments ? $posts[ $count ]-&gt;comments : get_comments( array( &#x27;post_id&#x27; =&gt; $post-&gt;ID ) );

      $args-&gt;documents[ ] = apply_filters( &#x27;ud_cloud::document&#x27;, $posts[ $count ] );

    }

    $args-&gt;documents = self::array_filter_deep( $args-&gt;documents );

    // No documents - either none matched post type, or were removed during QC
    if( !$args-&gt;documents ) {
      return null;
    }

    // Private API call can use Customer Key
    $post_url = implode( &#x27;/&#x27;, array( self::$url, self::$site_uid, ( isset( $document_type ) &amp;&amp; !empty( $document_type ) ? $document_type : &#x27;default&#x27; ), &#x27;?key=&#x27; . self::$customer_key ) );

    if( is_wp_error( $_response = wp_remote_post( $post_url, array( &#x27;timeout&#x27; =&gt; 60, &#x27;body&#x27; =&gt; $args ) ) ) ) {
      return self::log( $_response );
    }

    $_response[ &#x27;post_url&#x27; ] = $post_url;
    $_response[ &#x27;timer&#x27; ] = self::timer_stop( __METHOD__ );
    $_response[ &#x27;body&#x27; ] = (object) array_filter( (array) json_decode( $_response[ &#x27;body&#x27; ], true ) );

    switch( true ) {

      case $_response[ &#x27;response&#x27; ][ &#x27;code&#x27; ] == 500:
        return self::log( new WP_Error( __METHOD__, &#x27;UD Cloud API error occured during an attempt to index.&#x27;, $_response ) );
        break;

      case ( is_object( $_response[ &#x27;body&#x27; ] ) &amp;&amp; !$_response[ &#x27;body&#x27; ]-&gt;success &amp;&amp; $_response[ &#x27;body&#x27; ]-&gt;message ):
        return self::log( new WP_Error( __METHOD__, $_response[ &#x27;body&#x27; ]-&gt;message, $_response ) );
        break;

    }

    $count = 0;
    foreach( (array) $_response[ &#x27;body&#x27; ]-&gt;documents as $item_id =&gt; $item ) {
      $count++;
      try {

        if( $item[ &#x27;error&#x27; ] ) {
          throw new Exception( &#x27;An error occurred with the following message: &#x27; + $item[ &#x27;error&#x27; ] );
        }

        if( !$item[ &#x27;_id&#x27; ] ) {
          throw new Exception( &#x27;The document could not be properly indexed.&#x27; );
        }

        if( $item_id != $item[ &#x27;_id&#x27; ] ) {
          throw new Exception( &#x27;Item ID mismatch detected.&#x27; );
        }

        update_post_meta( $posts[ $count ]-&gt;ID, &#x27;ud_cloud::_id&#x27;, $item[ &#x27;_id&#x27; ] );
        update_post_meta( $posts[ $count ]-&gt;ID, &#x27;ud_cloud::_version&#x27;, $item[ &#x27;_version&#x27; ] );
        update_post_meta( $posts[ $count ]-&gt;ID, &#x27;ud_cloud::synchronized&#x27;, time() );

      } catch( Exception $e ) {
        update_post_meta( $posts[ $count ]-&gt;ID, &#x27;ud_cloud::_id&#x27;, $item[ &#x27;_id&#x27; ] );
        delete_post_meta( $posts[ $count ]-&gt;ID, &#x27;ud_cloud::synchronized&#x27; );
        self::object_log( $posts[ $count ]-&gt;ID, $e-&gt;getMessage() );
      }

    }

    if( $_response[ &#x27;body&#x27; ]-&gt;meta ) {
      update_option( self::$option . &#x27;::meta&#x27;, array_merge( (array) get_option( self::$option . &#x27;::meta&#x27; ), $_response[ &#x27;body&#x27; ]-&gt;meta ) );
    }

    self::log( &#x27;Cloud Update process complete in &#x27; . self::timer_stop( __METHOD__ ) . &#x27; seconds.&#x27; );

    return $_response[ &#x27;body&#x27; ]-&gt;success ? $_response[ &#x27;body&#x27; ] : new WP_Error( &#x27;UD_Cloud::index&#x27;, &#x27;Unknown error occured during indexing.&#x27;, $_response );

  }

  /**
   * Delete Document from Cloud
   *
   * @action before_delete_post|wp_trash_post
   * @todo Must use DELETE method for request, also uses wrong key.
   */
  static function delete( $id, $type = &#x27;&#x27; ) {
    wp_remote_request( implode( &#x27;/&#x27;, array( self::$url, self::$site_uid, $type, $id, &#x27;_delete?key=&#x27; . self::$customer_key ) ), array( &#x27;method&#x27; =&gt; &#x27;GET&#x27; ) );
    delete_post_meta( $id, &#x27;ud_cloud::_id&#x27; );
    delete_post_meta( $id, &#x27;ud_cloud::_version&#x27; );
    delete_post_meta( $id, &#x27;ud_cloud::synchronized&#x27; );
  }

  /**
   * Updates system log.
   *
   * @since 1.0.0
   * @author potanin@UD
   */
  static function log( $data ) {

    if( defined( &#x27;WP_DEBUG&#x27; ) &amp;&amp; WP_DEBUG &amp;&amp; is_wp_error( $data ) ) {
      wp_die( &#x27;&lt;h1&gt;Debug Log&lt;/h1&gt;&lt;pre&gt;&#x27; . print_r( $data, true ) . &#x27;&lt;/pre&gt;&#x27; );
    }

    return $data;

  }

  /**
   * Updates object log
   *
   * @since 1.0.1
   */
  static function object_log( $id, $data ) {
    add_post_meta( $id, &#x27;ud_cloud::log&#x27;, $data );
    return $id;
  }

  /**
   * Load Configuration Data from Option, stored as JSON
   *
   * @version 1.0.0
   * @since 1.0.0
   * @author potanin@UD
   */
  static function get_configuration( $type = &#x27;&#x27; ) {

    $defaults = array(
      &#x27;documents&#x27; =&gt; array(),
      &#x27;meta&#x27; =&gt; array(
        &#x27;callback_url&#x27; =&gt; admin_url( &#x27;admin-ajax.php?action=ud::UD_Cloud&amp;api_key=&#x27; . self::$api_key ),
        &#x27;user_ip&#x27; =&gt; $_SERVER[ &#x27;REMOTE_ADDR&#x27; ],
        &#x27;client_ip&#x27; =&gt; $_SERVER[ &#x27;SERVER_ADDR&#x27; ],
        &#x27;client&#x27; =&gt; self::$client,
        &#x27;defaults&#x27; =&gt; array(),
        &#x27;acl&#x27; =&gt; array()
      ),
      &#x27;schema&#x27; =&gt; array()
    );

    $configuration = array();

    try {

      //** Search for specific type config */
      if ( file_exists( $_static = dirname( __FILE__ ) . DIRECTORY_SEPARATOR . &quot;ud_cloud.$type.config.json&quot; ) ) {

        $configuration = json_decode( file_get_contents( $_static ), true );

      } else {

        //** If there is no specific - use default if it exists */
        if( file_exists( $_static = dirname( __FILE__ ) . DIRECTORY_SEPARATOR . self::$defaults ) || file_exists( $_static = self::$defaults ) ) {
          $configuration = json_decode( file_get_contents( $_static ), true );
        } else {
          $configuration = maybe_unserialize( json_decode( get_option( self::$option ), true ) );
        }

      }

    } catch( Exception $e ) {
      self::log( $e );
    }

    return json_decode( json_encode( self::extend( (array) $configuration, $defaults ) ) );

  }

  /**
   * Get information about information stored in cloud, synchronization status, etc.
   *
   * @since 2.0
   * @author potanin@UD
   */
  static function status() {
    $response = wp_remote_get( add_query_arg( array( &#x27;site_uid&#x27; =&gt; self::get_key( &#x27;site_uid&#x27; ), &#x27;public_key&#x27; =&gt; self::get_key( &#x27;public_key&#x27; ) ), &#x27;http://cloud.usabilitydynamics.com/status.json&#x27; ) );
    if( !is_wp_error( $response ) ) {
      $response = $response[ &#x27;body&#x27; ];
    }
    return $response;
  }

  /**
   * Initializes Bridge by Adding Filters
   *
   * @since 1.0.0
   * @author potanin@UD
   */
  static function post_submitbox_misc_actions() {
    global $post;

    if( $synchronized = get_post_meta( $post-&gt;ID, &#x27;ud_cloud::synchronized&#x27;, true ) ) {
      $synchronized = human_time_diff( $synchronized ) . &#x27; ago&#x27;;

      if( $synchronized == &#x27;1 min ago&#x27; ) {
        $synchronized = &#x27;Just now&#x27;;
      }

    }

    if( !$synchronized &amp;&amp; !in_array( $post-&gt;post_type, (array) get_option( self::$option . &#x27;::post_types&#x27; ) ) ) {
      return;
    }

    $html = array();

    $html[ ] = &#x27;&lt;div class=&quot;misc-pub-section curtime&quot;&gt;&#x27;;

    if( $synchronized ) {
      $html[ ] = &#x27;&lt;span id=&quot;timestamp&quot;&gt;Cloud Synchronization: &lt;b&gt;&#x27; . $synchronized . &#x27;&lt;/b&gt;&lt;/span&gt;&#x27;;
    } else {
      $html[ ] = &#x27;&lt;span id=&quot;timestamp&quot;&gt;Pending Cloud Synchronization.&lt;/span&gt;&#x27;;
    }

    $html[ ] = &#x27;&lt;/div&gt;&#x27;;

    echo implode( &#x27;&#x27;, $html );

  }

}

}
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
