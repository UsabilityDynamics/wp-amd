<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/modules/cdn-media/lib/Bjork/bjork/contrib/sessions/backends/base.php - wp-flawless</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://a3d72a45d111006ec192-ec5b80a12b0b09b4d52373336afb4254.r80.cf1.rackcdn.com/usability-dynamics.png" title="wp-flawless"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/API.html">API</a></li>
            
                <li><a href="../classes/Carrington.html">Carrington</a></li>
            
                <li><a href="../classes/Extended_Taxonomies.html">Extended_Taxonomies</a></li>
            
                <li><a href="../classes/Flawless.API.html">Flawless.API</a></li>
            
                <li><a href="../classes/Flawless.Asset.html">Flawless.Asset</a></li>
            
                <li><a href="../classes/Flawless.Branded_Login.html">Flawless.Branded_Login</a></li>
            
                <li><a href="../classes/Flawless.BuddyPress.html">Flawless.BuddyPress</a></li>
            
                <li><a href="../classes/Flawless.Content.html">Flawless.Content</a></li>
            
                <li><a href="../classes/Flawless.Element.html">Flawless.Element</a></li>
            
                <li><a href="../classes/Flawless.Flawless\Shortcode.html">Flawless.Flawless\Shortcode</a></li>
            
                <li><a href="../classes/Flawless.Management.html">Flawless.Management</a></li>
            
                <li><a href="../classes/Flawless.Mobile.html">Flawless.Mobile</a></li>
            
                <li><a href="../classes/Flawless.Navbars.html">Flawless.Navbars</a></li>
            
                <li><a href="../classes/Flawless.Schema.html">Flawless.Schema</a></li>
            
                <li><a href="../classes/Flawless.Settings.html">Flawless.Settings</a></li>
            
                <li><a href="../classes/Flawless.Styles.html">Flawless.Styles</a></li>
            
                <li><a href="../classes/Flawless.Utility.html">Flawless.Utility</a></li>
            
                <li><a href="../classes/Flawless.Widget.html">Flawless.Widget</a></li>
            
                <li><a href="../classes/flawless_wpp_extensions.html">flawless_wpp_extensions</a></li>
            
                <li><a href="../classes/Legacy.html">Legacy</a></li>
            
                <li><a href="../classes/License.html">License</a></li>
            
                <li><a href="../classes/Loader.html">Loader</a></li>
            
                <li><a href="../classes/Log.html">Log</a></li>
            
                <li><a href="../classes/Maintenance.html">Maintenance</a></li>
            
                <li><a href="../classes/Models.html">Models</a></li>
            
                <li><a href="../classes/Module.html">Module</a></li>
            
                <li><a href="../classes/Multisite.html">Multisite</a></li>
            
                <li><a href="../classes/SaaS.html">SaaS</a></li>
            
                <li><a href="../classes/Shortcode.html">Shortcode</a></li>
            
                <li><a href="../classes/Shortcodes.html">Shortcodes</a></li>
            
                <li><a href="../classes/Template Methods.html">Template Methods</a></li>
            
                <li><a href="../classes/Theme.html">Theme</a></li>
            
                <li><a href="../classes/UI.html">UI</a></li>
            
                <li><a href="../classes/Utility.html">Utility</a></li>
            
                <li><a href="../classes/Views.html">Views</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/API.html">API</a></li>
            
                <li><a href="../modules/Branded Login.html">Branded Login</a></li>
            
                <li><a href="../modules/Carrington.html">Carrington</a></li>
            
                <li><a href="../modules/Carrington Build.html">Carrington Build</a></li>
            
                <li><a href="../modules/carrington-build.html">carrington-build</a></li>
            
                <li><a href="../modules/cfct_build.html">cfct_build</a></li>
            
                <li><a href="../modules/default.html">default</a></li>
            
                <li><a href="../modules/Flawless.html">Flawless</a></li>
            
                <li><a href="../modules/Loader.html">Loader</a></li>
            
                <li><a href="../modules/Log.html">Log</a></li>
            
                <li><a href="../modules/Maintenence.html">Maintenence</a></li>
            
                <li><a href="../modules/Management.html">Management</a></li>
            
                <li><a href="../modules/Multisite.html">Multisite</a></li>
            
                <li><a href="../modules/SaaS.html">SaaS</a></li>
            
                <li><a href="../modules/Services_JSON.html">Services_JSON</a></li>
            
                <li><a href="../modules/Shortcodes.html">Shortcodes</a></li>
            
                <li><a href="../modules/taxonomy-landing

This file is part of Taxonomy Landing for WordPress
http:__github.com_crowdfavorite_wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http:__crowdfavorite.com

Released under the GPL license
http:__www.opensource.org_licenses_gpl-license.php

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************.html">taxonomy-landing

This file is part of Taxonomy Landing for WordPress
http://github.com/crowdfavorite/wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http://crowdfavorite.com

Released under the GPL license
http://www.opensource.org/licenses/gpl-license.php

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************</a></li>
            
                <li><a href="../modules/taxonomy-landing

This file is part of Taxonomy Landing for WordPress
https:__github.com_crowdfavorite_wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http:__crowdfavorite.com

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************.html">taxonomy-landing

This file is part of Taxonomy Landing for WordPress
https://github.com/crowdfavorite/wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http://crowdfavorite.com

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************</a></li>
            
                <li><a href="../modules/Theme UI.html">Theme UI</a></li>
            
                <li><a href="../modules/UI.html">UI</a></li>
            
                <li><a href="../modules/UsabilityDynamics.html">UsabilityDynamics</a></li>
            
                <li><a href="../modules/Utility.html">Utility</a></li>
            
                <li><a href="../modules/Views.html">Views</a></li>
            
                <li><a href="../modules/WP-Property.html">WP-Property</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: core/modules/cdn-media/lib/Bjork/bjork/contrib/sessions/backends/base.php</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&lt;?php

namespace bjork\contrib\sessions\backends\base;

use strutils;

use bjork\conf\settings,
    bjork\core\exceptions\SuspiciousOperation,
    bjork\utils\crypto,
    bjork\utils\http;

/**
* Used internally as a consistent exception type to catch from save.
* (see the docstring for SessionBase.save() for details).
*/
class CreateError extends \Exception {}

/**
* Base class for all Session classes.
*/
abstract class SessionBase implements \ArrayAccess {
    const MAX_SESSION_KEY = 18446744073709551616; // 2&lt;&lt;63
    const TEST_COOKIE_NAME = &#x27;testcookie&#x27;;
    const TEST_COOKIE_VALUE = &#x27;worked&#x27;;
    const SESSION_LOADED_SENTINEL = -987654321;
    
    protected
        $session_key,
        $session_cache,
        $accessed,
        $modified;
    
    function __construct($session_key=null) {
        $this-&gt;session_cache = self::SESSION_LOADED_SENTINEL;
        $this-&gt;session_key = $session_key;
        $this-&gt;accessed = false;
        $this-&gt;modified = false;
    }
    
    //-- ArrayAccess interface ----------------------------------------------
    
    function offsetExists($key) {
        return array_key_exists($key, $this-&gt;getSessionData());
    }
    
    function offsetGet($key) {
        $data = $this-&gt;getSessionData();
        if (!array_key_exists($key, $data))
            throw new \OutOfBoundsException($key);
        return $data[$key];
    }
    
    function offsetSet($key, $value) {
        $data = $this-&gt;getSessionData();
        $data[$key] = $value;
        $this-&gt;setSessionData($data);
        $this-&gt;modified = true;
    }
    
    function offsetUnset($key) {
        $data = $this-&gt;getSessionData();
        unset($data[$key]);
        $this-&gt;setSessionData($data);
        $this-&gt;modified = true;
    }
    
    //-- Public API ---------------------------------------------------------
    
    public function get($key, $default=null) {
        if ($this-&gt;offsetExists($key))
            return $this-&gt;offsetGet($key);
        return $default;
    }
    
    public function set($key, $value) {
        $this-&gt;offsetSet($key, $value);
    }
    
    public function setDefault($key, $value) {
        if ($this-&gt;offsetExists($key))
            return $this-&gt;offsetGet($key);
        $this-&gt;offsetSet($key, $value);
        return $value;
    }
    
    public function hasKey($key) {
        return $this-&gt;offsetExists($key);
    }
    
    public function update(array $dict) {
        // we don&#x27;t iterate over the $dict and offsetSet()
        // as this could be costly on some backends
        $data = array_merge($this-&gt;getSessionData(), $dict);
        $this-&gt;setSessionData($data);
        $this-&gt;modified = true;
    }
    
    public function pop($key /*, $default */) {
        $args = func_get_args();
        $data = $this-&gt;getSessionData();
        $this-&gt;modified = $this-&gt;modified || isset($data[$key]);
        if (isset($data[$key])) {
            unset($data[$key]);
            $this-&gt;setSessionData($data);
        } else {
            if (count($args) &gt; 1)
                return $args[1];
            throw new \Exception(&quot;&quot;.__CLASS__.&quot; object has no property &#x27;{$k}&#x27;&quot;);
        }
    }
    
    public function clear() {
        // To avoid unnecessary persistent storage accesses, we set up the
        // internals directly (loading data wastes time, since we are going
        // to set it to an empty dict anyway).
        $this-&gt;session_cache = array();
        $this-&gt;accessed = true;
        $this-&gt;modified = true;
    }
    
    /**
    * Removes the current session data from the database and regenerates
    * the key.
    */
    public function flush() {
        $this-&gt;clear();
        $this-&gt;delete();
        $this-&gt;create();
    }
    
    /**
    * Creates a new session key, whilst retaining the current session data.
    */
    public function cycleKey() {
        $data = $this-&gt;session_cache;
        $key = $this-&gt;session_key;
        $this-&gt;create();
        $this-&gt;session_cache = $data;
        $this-&gt;delete($key);
    }
    
    public function isAccessed() {
        return $this-&gt;accessed;
    }
    
    public function isModified() {
        return $this-&gt;modified;
    }
    
    /**
    * Get the session&#x27;s expiry date (as a DateTime object).
    */
    public function getExpiryDate() {
        $expiry = $this-&gt;get(&#x27;_session_expiry&#x27;);
        if ($expiry instanceof \DateTime)
            return $expiry;
        if (!$expiry) // checks both null and 0 cases
            $expiry = settings::get(&#x27;SESSION_COOKIE_AGE&#x27;);
        $now = new \DateTime();
        return $now-&gt;add(\DateInterval::createFromDateString($expiry.&#x27; seconds&#x27;));
    }
    
    /**
    * Get the number of seconds until the session expires.
    */
    public function getExpiryAge() {
        $expiry = $this-&gt;get(&#x27;_session_expiry&#x27;);
        if (!$expiry) // checks both null and 0 cases
            return settings::get(&#x27;SESSION_COOKIE_AGE&#x27;);
        if (!($expiry instanceof \DateTime))
            return $expiry;
        $delta = $expiry-&gt;diff(new \DateTime());
        return $delta-&gt;days * 86400 + $delta-&gt;h * 24 + $delta-&gt;m * 60 + $delta-&gt;s;
    }
    
    /**
    * Sets a custom expiration for the session. &#x60;&#x60;value&#x60;&#x60; can be an integer,
    * a &#x60;&#x60;DateTime&#x60;&#x60; or &#x60;&#x60;DateInterval&#x60;&#x60; object or &#x60;&#x60;null&#x60;&#x60;.
    *
    * If &#x60;&#x60;value&#x60;&#x60; is an integer, the session will expire after that many
    * seconds of inactivity. If set to &#x60;&#x60;0&#x60;&#x60; then the session will expire on
    * browser close.
    *
    * If &#x60;&#x60;value&#x60;&#x60; is a &#x60;&#x60;DateTime&#x60;&#x60; or &#x60;&#x60;DateInterval&#x60;&#x60; object, the session
    * will expire at that specific future time.
    *
    * If &#x60;&#x60;value&#x60;&#x60; is &#x60;&#x60;null&#x60;&#x60;, the session uses the global session expiry
    * policy.
    */
    public function setExpiry($value) {
        if (null === $value) {
            // Remove any custom expiration for this session.
            $this-&gt;offsetUnset(&#x27;_session_expiry&#x27;);
            return;
        }
        if ($value instanceof \DateInterval) {
            $now = new \DateTime();
            $value = $now-&gt;add($value);
        } else if (is_int($value)) { // timestamp
            $value = new \DateTime(&#x27;@&#x27; . strval($value));
        }
        $this-&gt;offsetSet(&#x27;_session_expiry&#x27;, $value);
    }
    
    /**
    * Returns &#x60;&#x60;true&#x60;&#x60; if the session is set to expire when the browser
    * closes, and &#x60;&#x60;false&#x60;&#x60; if there&#x27;s an expiry date. Use &#x60;&#x60;getExpiryDate()&#x60;&#x60;
    * or &#x60;&#x60;getExpiryAge()&#x60;&#x60; to find the actual expiry date/age, if there
    * is one.
    */
    public function expiresAtBrowserClose() {
        if (null === $this-&gt;get(&#x27;_session_expiry&#x27;))
            return settings::get(&#x27;SESSION_EXPIRE_AT_BROWSER_CLOSE&#x27;);
        return $this-&gt;get(&#x27;_session_expiry&#x27;) === 0;
    }
    
    public function getSessionKey() {
        if (!empty($this-&gt;session_key))
            return $this-&gt;session_key;
        $this-&gt;session_key = $this-&gt;getNewSessionKey();
        return $this-&gt;session_key;
    }
    
    public function setSessionKey($key) {
        $this-&gt;session_key = $key;
    }
    
    //-- Test cookie --------------------------------------------------------
    
    public function setTestCookie() {
        $this-&gt;offsetSet(self::TEST_COOKIE_NAME, self::TEST_COOKIE_VALUE);
    }
    
    public function testCookieWorked() {
        return $this-&gt;get(self::TEST_COOKIE_NAME) === self::TEST_COOKIE_VALUE;
    }
    
    public function deleteTestCookie() {
        $this-&gt;offsetUnset(self::TEST_COOKIE_NAME);
    }
    
    //-- Methods subclasses can override ------------------------------------
    
    /**
    * Lazily loads session from storage (unless &quot;no_load&quot; is True, when only
    * an empty dict is stored) and stores it in the current instance.
    */
    protected function getSessionData($no_load=false) {
        $this-&gt;accessed = true;
        if ($this-&gt;session_cache === self::SESSION_LOADED_SENTINEL) {
            if (null === $this-&gt;session_key || $no_load)
                $this-&gt;session_cache = array();
            else
                $this-&gt;session_cache = $this-&gt;load();
        }
        return $this-&gt;session_cache;
    }
    
    private function setSessionData(array $data) {
        $this-&gt;session_cache = $data;
    }
    
    /**
    * Returns a session key that isn&#x27;t being used.
    */
    protected function getNewSessionKey() {
        $pid = getmypid();
        while (true) {
            $session_key = md5(sprintf(&#x27;%s%s%s%s&#x27;,
                mt_rand(0, self::MAX_SESSION_KEY - 1),
                $pid,
                time(),
                settings::get(&#x27;SECRET_KEY&#x27;)
            ));
            if (!$this-&gt;exists($session_key))
                break;
        }
        return $session_key;
    }
    
    protected function hash($value) {
        $key_salt = &#x27;bjork.contrib.sessions.&#x27; . get_called_class();
        return crypto::salted_hmac($key_salt, $value);
    }
    
    /**
    * Returns the given session dictionary pickled and encoded as a string.
    */
    protected function encode(array $session_dict) {
        $serialized = serialize($session_dict);
        $hash = $this-&gt;hash($serialized);
        return http::b64encode($hash . &#x27;:&#x27; . $serialized);
    }
    
    protected function decode($session_data) {
        $encoded_data = http::b64decode($session_data);
        try {
            list($hash, $serialized) = strutils::split($encoded_data, &#x27;:&#x27;, 1);
            $expected_hash = $this-&gt;hash($serialized);
            if (!crypto::constant_time_compare($hash, $expected_hash))
                throw new SuspiciousOperation(&#x27;Session data corrupted&#x27;);
            return unserialize($serialized);
        } catch (\Exception $e) {
            // \BjorkException while unserializing, SuspiciousOperation.
            // We catch these and return an empty array.
            return array();
        }
    }
    
    //-- Methods subclasses must implement -----------------------------------
    
    /**
    * Returns True if the given session_key already exists.
    */
    abstract function exists($session_key);
    
    /**
    * Creates a new session instance. Guaranteed to create a new object with
    * a unique key and will have saved the result once (with empty data)
    * before the method returns.
    */
    abstract function create();
    
    /**
    * Saves the session data. If &#x27;must_create&#x27; is True, a new session object
    * is created (otherwise a CreateError exception is raised). Otherwise,
    * save() can update an existing object with the same key.
    */
    abstract function save($must_create=false);
    
    /**
    * Deletes the session data under this key. If the key is None, the
    * current session key value is used.
    */
    abstract function delete($session_key=null);
    
    /**
    * Loads the session data and returns a dictionary.
    */
    abstract function load();
}

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
