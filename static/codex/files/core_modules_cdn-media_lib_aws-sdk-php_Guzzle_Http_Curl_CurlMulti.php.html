<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/modules/cdn-media/lib/aws-sdk-php/Guzzle/Http/Curl/CurlMulti.php - wp-flawless</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://a3d72a45d111006ec192-ec5b80a12b0b09b4d52373336afb4254.r80.cf1.rackcdn.com/usability-dynamics.png" title="wp-flawless"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/API.html">API</a></li>
            
                <li><a href="../classes/Carrington.html">Carrington</a></li>
            
                <li><a href="../classes/Extended_Taxonomies.html">Extended_Taxonomies</a></li>
            
                <li><a href="../classes/Flawless.API.html">Flawless.API</a></li>
            
                <li><a href="../classes/Flawless.Asset.html">Flawless.Asset</a></li>
            
                <li><a href="../classes/Flawless.Branded_Login.html">Flawless.Branded_Login</a></li>
            
                <li><a href="../classes/Flawless.BuddyPress.html">Flawless.BuddyPress</a></li>
            
                <li><a href="../classes/Flawless.Content.html">Flawless.Content</a></li>
            
                <li><a href="../classes/Flawless.Element.html">Flawless.Element</a></li>
            
                <li><a href="../classes/Flawless.Flawless\Shortcode.html">Flawless.Flawless\Shortcode</a></li>
            
                <li><a href="../classes/Flawless.Management.html">Flawless.Management</a></li>
            
                <li><a href="../classes/Flawless.Mobile.html">Flawless.Mobile</a></li>
            
                <li><a href="../classes/Flawless.Navbars.html">Flawless.Navbars</a></li>
            
                <li><a href="../classes/Flawless.Schema.html">Flawless.Schema</a></li>
            
                <li><a href="../classes/Flawless.Settings.html">Flawless.Settings</a></li>
            
                <li><a href="../classes/Flawless.Styles.html">Flawless.Styles</a></li>
            
                <li><a href="../classes/Flawless.Utility.html">Flawless.Utility</a></li>
            
                <li><a href="../classes/Flawless.Widget.html">Flawless.Widget</a></li>
            
                <li><a href="../classes/flawless_wpp_extensions.html">flawless_wpp_extensions</a></li>
            
                <li><a href="../classes/Legacy.html">Legacy</a></li>
            
                <li><a href="../classes/License.html">License</a></li>
            
                <li><a href="../classes/Loader.html">Loader</a></li>
            
                <li><a href="../classes/Log.html">Log</a></li>
            
                <li><a href="../classes/Maintenance.html">Maintenance</a></li>
            
                <li><a href="../classes/Models.html">Models</a></li>
            
                <li><a href="../classes/Module.html">Module</a></li>
            
                <li><a href="../classes/Multisite.html">Multisite</a></li>
            
                <li><a href="../classes/SaaS.html">SaaS</a></li>
            
                <li><a href="../classes/Shortcode.html">Shortcode</a></li>
            
                <li><a href="../classes/Shortcodes.html">Shortcodes</a></li>
            
                <li><a href="../classes/Template Methods.html">Template Methods</a></li>
            
                <li><a href="../classes/Theme.html">Theme</a></li>
            
                <li><a href="../classes/UI.html">UI</a></li>
            
                <li><a href="../classes/Utility.html">Utility</a></li>
            
                <li><a href="../classes/Views.html">Views</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/API.html">API</a></li>
            
                <li><a href="../modules/Branded Login.html">Branded Login</a></li>
            
                <li><a href="../modules/Carrington.html">Carrington</a></li>
            
                <li><a href="../modules/Carrington Build.html">Carrington Build</a></li>
            
                <li><a href="../modules/carrington-build.html">carrington-build</a></li>
            
                <li><a href="../modules/cfct_build.html">cfct_build</a></li>
            
                <li><a href="../modules/default.html">default</a></li>
            
                <li><a href="../modules/Flawless.html">Flawless</a></li>
            
                <li><a href="../modules/Loader.html">Loader</a></li>
            
                <li><a href="../modules/Log.html">Log</a></li>
            
                <li><a href="../modules/Maintenence.html">Maintenence</a></li>
            
                <li><a href="../modules/Management.html">Management</a></li>
            
                <li><a href="../modules/Multisite.html">Multisite</a></li>
            
                <li><a href="../modules/SaaS.html">SaaS</a></li>
            
                <li><a href="../modules/Services_JSON.html">Services_JSON</a></li>
            
                <li><a href="../modules/Shortcodes.html">Shortcodes</a></li>
            
                <li><a href="../modules/taxonomy-landing

This file is part of Taxonomy Landing for WordPress
http:__github.com_crowdfavorite_wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http:__crowdfavorite.com

Released under the GPL license
http:__www.opensource.org_licenses_gpl-license.php

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************.html">taxonomy-landing

This file is part of Taxonomy Landing for WordPress
http://github.com/crowdfavorite/wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http://crowdfavorite.com

Released under the GPL license
http://www.opensource.org/licenses/gpl-license.php

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************</a></li>
            
                <li><a href="../modules/taxonomy-landing

This file is part of Taxonomy Landing for WordPress
https:__github.com_crowdfavorite_wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http:__crowdfavorite.com

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************.html">taxonomy-landing

This file is part of Taxonomy Landing for WordPress
https://github.com/crowdfavorite/wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http://crowdfavorite.com

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************</a></li>
            
                <li><a href="../modules/Theme UI.html">Theme UI</a></li>
            
                <li><a href="../modules/UI.html">UI</a></li>
            
                <li><a href="../modules/UsabilityDynamics.html">UsabilityDynamics</a></li>
            
                <li><a href="../modules/Utility.html">Utility</a></li>
            
                <li><a href="../modules/Views.html">Views</a></li>
            
                <li><a href="../modules/WP-Property.html">WP-Property</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: core/modules/cdn-media/lib/aws-sdk-php/Guzzle/Http/Curl/CurlMulti.php</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&lt;?php

namespace Guzzle\Http\Curl;

use Guzzle\Common\AbstractHasDispatcher;
use Guzzle\Http\Exception\MultiTransferException;
use Guzzle\Http\Exception\CurlException;
use Guzzle\Http\Message\RequestInterface;

/**
 * Send {@see RequestInterface} objects in parallel using curl_multi
 */
class CurlMulti extends AbstractHasDispatcher implements CurlMultiInterface
{
    /** @var resource cURL multi handle. */
    protected $multiHandle;

    /** @var array Attached {@see RequestInterface} objects. */
    protected $requests;

    /** @var \SplObjectStorage RequestInterface to CurlHandle hash */
    protected $handles;

    /** @var array Hash mapping curl handle resource IDs to request objects */
    protected $resourceHash;

    /** @var array Queued exceptions */
    protected $exceptions = array();

    /** @var array Requests that succeeded */
    protected $successful = array();

    /** @var array cURL multi error values and codes */
    protected $multiErrors = array(
        CURLM_BAD_HANDLE      =&gt; array(&#x27;CURLM_BAD_HANDLE&#x27;, &#x27;The passed-in handle is not a valid CURLM handle.&#x27;),
        CURLM_BAD_EASY_HANDLE =&gt; array(&#x27;CURLM_BAD_EASY_HANDLE&#x27;, &quot;An easy handle was not good/valid. It could mean that it isn&#x27;t an easy handle at all, or possibly that the handle already is in used by this or another multi handle.&quot;),
        CURLM_OUT_OF_MEMORY   =&gt; array(&#x27;CURLM_OUT_OF_MEMORY&#x27;, &#x27;You are doomed.&#x27;),
        CURLM_INTERNAL_ERROR  =&gt; array(&#x27;CURLM_INTERNAL_ERROR&#x27;, &#x27;This can only be returned if libcurl bugs. Please report it to us!&#x27;)
    );

    public function __construct()
    {
        $this-&gt;multiHandle = curl_multi_init();
        // @codeCoverageIgnoreStart
        if ($this-&gt;multiHandle === false) {
            throw new CurlException(&#x27;Unable to create multi handle&#x27;);
        }
        // @codeCoverageIgnoreEnd
        $this-&gt;reset();
    }

    public function __destruct()
    {
        if (is_resource($this-&gt;multiHandle)) {
            curl_multi_close($this-&gt;multiHandle);
        }
    }

    public function add(RequestInterface $request)
    {
        $this-&gt;requests[] = $request;
        // If requests are currently transferring and this is async, then the
        // request must be prepared now as the send() method is not called.
        $this-&gt;beforeSend($request);
        $this-&gt;dispatch(self::ADD_REQUEST, array(&#x27;request&#x27; =&gt; $request));

        return $this;
    }

    public function all()
    {
        return $this-&gt;requests;
    }

    public function remove(RequestInterface $request)
    {
        $this-&gt;removeHandle($request);
        foreach ($this-&gt;requests as $i =&gt; $r) {
            if ($request === $r) {
                unset($this-&gt;requests[$i]);
                $this-&gt;requests = array_values($this-&gt;requests);
                $this-&gt;dispatch(self::REMOVE_REQUEST, array(&#x27;request&#x27; =&gt; $request));
                return true;
            }
        }

        return false;
    }

    public function reset($hard = false)
    {
        // Remove each request
        if ($this-&gt;requests) {
            foreach ($this-&gt;requests as $request) {
                $this-&gt;remove($request);
            }
        }

        $this-&gt;handles = new \SplObjectStorage();
        $this-&gt;requests = $this-&gt;resourceHash = $this-&gt;exceptions = $this-&gt;successful = array();
    }

    public function send()
    {
        $this-&gt;perform();
        $exceptions = $this-&gt;exceptions;
        $successful = $this-&gt;successful;
        $this-&gt;reset();

        if ($exceptions) {
            $this-&gt;throwMultiException($exceptions, $successful);
        }
    }

    public function count()
    {
        return count($this-&gt;requests);
    }

    /**
     * Build and throw a MultiTransferException
     *
     * @param array $exceptions Exceptions encountered
     * @param array $successful Successful requests
     * @throws MultiTransferException
     */
    protected function throwMultiException(array $exceptions, array $successful)
    {
        $multiException = new MultiTransferException(&#x27;Errors during multi transfer&#x27;);

        while ($e = array_shift($exceptions)) {
            $multiException-&gt;add($e[&#x27;exception&#x27;]);
            $multiException-&gt;addFailedRequest($e[&#x27;request&#x27;]);
        }

        // Add successful requests
        foreach ($successful as $request) {
            if (!$multiException-&gt;containsRequest($request)) {
                $multiException-&gt;addSuccessfulRequest($request);
            }
        }

        throw $multiException;
    }

    /**
     * Prepare for sending
     *
     * @param RequestInterface $request Request to prepare
     * @throws \Exception on error preparing the request
     */
    protected function beforeSend(RequestInterface $request)
    {
        try {
            // Fix Content-Length and Transfer-Encoding collisions
            if ($request-&gt;hasHeader(&#x27;Transfer-Encoding&#x27;) &amp;&amp; $request-&gt;hasHeader(&#x27;Content-Length&#x27;)) {
                $request-&gt;removeHeader(&#x27;Transfer-Encoding&#x27;);
            }
            $request-&gt;setState(RequestInterface::STATE_TRANSFER);
            $request-&gt;dispatch(&#x27;request.before_send&#x27;, array(&#x27;request&#x27; =&gt; $request));
            if ($request-&gt;getState() != RequestInterface::STATE_TRANSFER) {
                // Requests might decide they don&#x27;t need to be sent just before transfer (e.g. CachePlugin)
                $this-&gt;remove($request);
                if ($request-&gt;getState() == RequestInterface::STATE_COMPLETE) {
                    $this-&gt;successful[] = $request;
                }
            } else {
                // Add the request curl handle to the multi handle
                $this-&gt;checkCurlResult(curl_multi_add_handle($this-&gt;multiHandle, $this-&gt;createCurlHandle($request)-&gt;getHandle()));
            }
        } catch (\Exception $e) {
            // Queue the exception to be thrown when sent
            $this-&gt;removeErroredRequest($request, $e);
        }
    }

    /**
     * Create a curl handle for a request
     *
     * @param RequestInterface $request Request
     *
     * @return CurlHandle
     */
    protected function createCurlHandle(RequestInterface $request)
    {
        $wrapper = CurlHandle::factory($request);
        $this-&gt;handles[$request] = $wrapper;
        $this-&gt;resourceHash[(int) $wrapper-&gt;getHandle()] = $request;

        return $wrapper;
    }

    /**
     * Get the data from the multi handle
     */
    protected function perform()
    {
        if (!$this-&gt;requests) {
            return;
        }

        // Initialize the handles with a very quick select timeout
        $active = $mrc = null;
        $this-&gt;executeHandles($active, $mrc, 0.001);
        $event = array(&#x27;curl_multi&#x27; =&gt; $this);

        while (1) {

            $this-&gt;processMessages();

            // Exit the function if there are no more requests to send
            if (!$this-&gt;requests) {
                break;
            }

            // Notify each request as polling
            $blocking = $total = 0;
            foreach ($this-&gt;requests as $request) {
                $event[&#x27;request&#x27;] = $request;
                $request-&gt;dispatch(self::POLLING_REQUEST, $event);
                ++$total;
                // The blocking variable just has to be non-falsey to block the loop
                if ($request-&gt;getParams()-&gt;hasKey(self::BLOCKING)) {
                    ++$blocking;
                }
            }

            if ($blocking == $total) {
                // Sleep to prevent eating CPU because no requests are actually pending a select call
                usleep(500);
            } else {
                do {
                    $this-&gt;executeHandles($active, $mrc, 1);
                } while ($active);
            }
        }
    }

    /**
     * Process any received curl multi messages
     */
    private function processMessages()
    {
        // Get messages from curl handles
        while ($done = curl_multi_info_read($this-&gt;multiHandle)) {
            try {
                $request = $this-&gt;resourceHash[(int) $done[&#x27;handle&#x27;]];
                $this-&gt;processResponse($request, $this-&gt;handles[$request], $done);
                $this-&gt;successful[] = $request;
            } catch (MultiTransferException $e) {
                $this-&gt;removeErroredRequest($request, $e, false);
                throw $e;
            } catch (\Exception $e) {
                $this-&gt;removeErroredRequest($request, $e);
            }
        }
    }

    /**
     * Execute and select curl handles until there is activity
     *
     * @param int $active  Active value to update
     * @param int $mrc     Multi result value to update
     * @param int $timeout Select timeout in seconds
     */
    private function executeHandles(&amp;$active, &amp;$mrc, $timeout = 1)
    {
        do {
            $mrc = curl_multi_exec($this-&gt;multiHandle, $active);
        } while ($mrc == CURLM_CALL_MULTI_PERFORM &amp;&amp; $active);
        $this-&gt;checkCurlResult($mrc);

        // @codeCoverageIgnoreStart
        // Select the curl handles until there is any activity on any of the open file descriptors
        // See https://github.com/php/php-src/blob/master/ext/curl/multi.c#L170
        if ($active &amp;&amp; $mrc == CURLM_OK &amp;&amp; curl_multi_select($this-&gt;multiHandle, $timeout) == -1) {
            // Perform a usleep if a previously executed select returned -1
            // @see https://bugs.php.net/bug.php?id=61141
            usleep(100);
        }
        // @codeCoverageIgnoreEnd
    }

    /**
     * Remove a request that encountered an exception
     *
     * @param RequestInterface $request Request to remove
     * @param \Exception       $e       Exception encountered
     * @param bool             $buffer  Set to false to not buffer the exception
     */
    protected function removeErroredRequest(RequestInterface $request, \Exception $e = null, $buffer = true)
    {
        if ($buffer) {
            $this-&gt;exceptions[] = array(&#x27;request&#x27; =&gt; $request, &#x27;exception&#x27; =&gt; $e);
        }

        $this-&gt;remove($request);
        $request-&gt;setState(RequestInterface::STATE_ERROR);
        $this-&gt;dispatch(self::MULTI_EXCEPTION, array(&#x27;exception&#x27; =&gt; $e, &#x27;all_exceptions&#x27; =&gt; $this-&gt;exceptions));
    }

    /**
     * Check for errors and fix headers of a request based on a curl response
     *
     * @param RequestInterface $request Request to process
     * @param CurlHandle       $handle  Curl handle object
     * @param array            $curl    Array returned from curl_multi_info_read
     *
     * @throws CurlException on Curl error
     */
    protected function processResponse(RequestInterface $request, CurlHandle $handle, array $curl)
    {
        // Set the transfer stats on the response
        $handle-&gt;updateRequestFromTransfer($request);
        // Check if a cURL exception occurred, and if so, notify things
        $curlException = $this-&gt;isCurlException($request, $handle, $curl);

        // Always remove completed curl handles.  They can be added back again
        // via events if needed (e.g. ExponentialBackoffPlugin)
        $this-&gt;removeHandle($request);

        if (!$curlException) {
            $request-&gt;setState(RequestInterface::STATE_COMPLETE, array(&#x27;handle&#x27; =&gt; $handle));
            // Only remove the request if it wasn&#x27;t resent as a result of the state change
            if ($request-&gt;getState() != RequestInterface::STATE_TRANSFER) {
                $this-&gt;remove($request);
            }
        } else {
            // Set the state of the request to an error
            $request-&gt;setState(RequestInterface::STATE_ERROR);
            // Notify things that listen to the request of the failure
            $request-&gt;dispatch(&#x27;request.exception&#x27;, array(
                &#x27;request&#x27;   =&gt; $this,
                &#x27;exception&#x27; =&gt; $curlException
            ));

            // Allow things to ignore the error if possible
            $state = $request-&gt;getState();
            if ($state != RequestInterface::STATE_TRANSFER) {
                $this-&gt;remove($request);
            }
            // The error was not handled, so fail
            if ($state == RequestInterface::STATE_ERROR) {
                /** @var CurlException $curlException */
                throw $curlException;
            }
        }
    }

    /**
     * Remove a curl handle from the curl multi object
     *
     * @param RequestInterface $request Request that owns the handle
     */
    protected function removeHandle(RequestInterface $request)
    {
        if (isset($this-&gt;handles[$request])) {
            $handle = $this-&gt;handles[$request];
            unset($this-&gt;handles[$request]);
            unset($this-&gt;resourceHash[(int) $handle-&gt;getHandle()]);
            curl_multi_remove_handle($this-&gt;multiHandle, $handle-&gt;getHandle());
            $handle-&gt;close();
        }
    }

    /**
     * Check if a cURL transfer resulted in what should be an exception
     *
     * @param RequestInterface $request Request to check
     * @param CurlHandle       $handle  Curl handle object
     * @param array            $curl    Array returned from curl_multi_info_read
     *
     * @return CurlException|bool
     */
    private function isCurlException(RequestInterface $request, CurlHandle $handle, array $curl)
    {
        if (CURLM_OK == $curl[&#x27;result&#x27;] || CURLM_CALL_MULTI_PERFORM == $curl[&#x27;result&#x27;]) {
            return false;
        }

        $handle-&gt;setErrorNo($curl[&#x27;result&#x27;]);
        $e = new CurlException(sprintf(&#x27;[curl] %s: %s [url] %s&#x27;,
            $handle-&gt;getErrorNo(), $handle-&gt;getError(), $handle-&gt;getUrl()));
        $e-&gt;setCurlHandle($handle)
            -&gt;setRequest($request)
            -&gt;setCurlInfo($handle-&gt;getInfo())
            -&gt;setError($handle-&gt;getError(), $handle-&gt;getErrorNo());

        return $e;
    }

    /**
     * Throw an exception for a cURL multi response if needed
     *
     * @param int $code Curl response code
     * @throws CurlException
     */
    private function checkCurlResult($code)
    {
        if ($code != CURLM_OK &amp;&amp; $code != CURLM_CALL_MULTI_PERFORM) {
            throw new CurlException(isset($this-&gt;multiErrors[$code])
                ? &quot;cURL error: {$code} ({$this-&gt;multiErrors[$code][0]}): cURL message: {$this-&gt;multiErrors[$code][1]}&quot;
                : &#x27;Unexpected cURL error: &#x27; . $code
            );
        }
    }
}

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
