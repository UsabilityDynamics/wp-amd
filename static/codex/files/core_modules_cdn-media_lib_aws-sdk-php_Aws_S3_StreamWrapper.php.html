<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/modules/cdn-media/lib/aws-sdk-php/Aws/S3/StreamWrapper.php - wp-flawless</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://a3d72a45d111006ec192-ec5b80a12b0b09b4d52373336afb4254.r80.cf1.rackcdn.com/usability-dynamics.png" title="wp-flawless"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/API.html">API</a></li>
            
                <li><a href="../classes/Carrington.html">Carrington</a></li>
            
                <li><a href="../classes/Extended_Taxonomies.html">Extended_Taxonomies</a></li>
            
                <li><a href="../classes/Flawless.API.html">Flawless.API</a></li>
            
                <li><a href="../classes/Flawless.Asset.html">Flawless.Asset</a></li>
            
                <li><a href="../classes/Flawless.Branded_Login.html">Flawless.Branded_Login</a></li>
            
                <li><a href="../classes/Flawless.BuddyPress.html">Flawless.BuddyPress</a></li>
            
                <li><a href="../classes/Flawless.Content.html">Flawless.Content</a></li>
            
                <li><a href="../classes/Flawless.Element.html">Flawless.Element</a></li>
            
                <li><a href="../classes/Flawless.Flawless\Shortcode.html">Flawless.Flawless\Shortcode</a></li>
            
                <li><a href="../classes/Flawless.Management.html">Flawless.Management</a></li>
            
                <li><a href="../classes/Flawless.Mobile.html">Flawless.Mobile</a></li>
            
                <li><a href="../classes/Flawless.Navbars.html">Flawless.Navbars</a></li>
            
                <li><a href="../classes/Flawless.Schema.html">Flawless.Schema</a></li>
            
                <li><a href="../classes/Flawless.Settings.html">Flawless.Settings</a></li>
            
                <li><a href="../classes/Flawless.Styles.html">Flawless.Styles</a></li>
            
                <li><a href="../classes/Flawless.Utility.html">Flawless.Utility</a></li>
            
                <li><a href="../classes/Flawless.Widget.html">Flawless.Widget</a></li>
            
                <li><a href="../classes/flawless_wpp_extensions.html">flawless_wpp_extensions</a></li>
            
                <li><a href="../classes/Legacy.html">Legacy</a></li>
            
                <li><a href="../classes/License.html">License</a></li>
            
                <li><a href="../classes/Loader.html">Loader</a></li>
            
                <li><a href="../classes/Log.html">Log</a></li>
            
                <li><a href="../classes/Maintenance.html">Maintenance</a></li>
            
                <li><a href="../classes/Models.html">Models</a></li>
            
                <li><a href="../classes/Module.html">Module</a></li>
            
                <li><a href="../classes/Multisite.html">Multisite</a></li>
            
                <li><a href="../classes/SaaS.html">SaaS</a></li>
            
                <li><a href="../classes/Shortcode.html">Shortcode</a></li>
            
                <li><a href="../classes/Shortcodes.html">Shortcodes</a></li>
            
                <li><a href="../classes/Template Methods.html">Template Methods</a></li>
            
                <li><a href="../classes/Theme.html">Theme</a></li>
            
                <li><a href="../classes/UI.html">UI</a></li>
            
                <li><a href="../classes/Utility.html">Utility</a></li>
            
                <li><a href="../classes/Views.html">Views</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/API.html">API</a></li>
            
                <li><a href="../modules/Branded Login.html">Branded Login</a></li>
            
                <li><a href="../modules/Carrington.html">Carrington</a></li>
            
                <li><a href="../modules/Carrington Build.html">Carrington Build</a></li>
            
                <li><a href="../modules/carrington-build.html">carrington-build</a></li>
            
                <li><a href="../modules/cfct_build.html">cfct_build</a></li>
            
                <li><a href="../modules/default.html">default</a></li>
            
                <li><a href="../modules/Flawless.html">Flawless</a></li>
            
                <li><a href="../modules/Loader.html">Loader</a></li>
            
                <li><a href="../modules/Log.html">Log</a></li>
            
                <li><a href="../modules/Maintenence.html">Maintenence</a></li>
            
                <li><a href="../modules/Management.html">Management</a></li>
            
                <li><a href="../modules/Multisite.html">Multisite</a></li>
            
                <li><a href="../modules/SaaS.html">SaaS</a></li>
            
                <li><a href="../modules/Services_JSON.html">Services_JSON</a></li>
            
                <li><a href="../modules/Shortcodes.html">Shortcodes</a></li>
            
                <li><a href="../modules/taxonomy-landing

This file is part of Taxonomy Landing for WordPress
http:__github.com_crowdfavorite_wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http:__crowdfavorite.com

Released under the GPL license
http:__www.opensource.org_licenses_gpl-license.php

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************.html">taxonomy-landing

This file is part of Taxonomy Landing for WordPress
http://github.com/crowdfavorite/wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http://crowdfavorite.com

Released under the GPL license
http://www.opensource.org/licenses/gpl-license.php

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************</a></li>
            
                <li><a href="../modules/taxonomy-landing

This file is part of Taxonomy Landing for WordPress
https:__github.com_crowdfavorite_wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http:__crowdfavorite.com

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************.html">taxonomy-landing

This file is part of Taxonomy Landing for WordPress
https://github.com/crowdfavorite/wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http://crowdfavorite.com

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************</a></li>
            
                <li><a href="../modules/Theme UI.html">Theme UI</a></li>
            
                <li><a href="../modules/UI.html">UI</a></li>
            
                <li><a href="../modules/UsabilityDynamics.html">UsabilityDynamics</a></li>
            
                <li><a href="../modules/Utility.html">Utility</a></li>
            
                <li><a href="../modules/Views.html">Views</a></li>
            
                <li><a href="../modules/WP-Property.html">WP-Property</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: core/modules/cdn-media/lib/aws-sdk-php/Aws/S3/StreamWrapper.php</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&lt;?php
/**
 * Copyright 2010-2013 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;).
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *
 * http://aws.amazon.com/apache2.0
 *
 * or in the &quot;license&quot; file accompanying this file. This file is distributed
 * on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

namespace Aws\S3;

use Aws\Common\Exception\RuntimeException;
use Aws\S3\Exception\S3Exception;
use Aws\S3\Exception\NoSuchKeyException;
use Aws\S3\Iterator\ListObjectsIterator;
use Guzzle\Http\QueryString;
use Guzzle\Http\EntityBody;
use Guzzle\Http\CachingEntityBody;
use Guzzle\Stream\PhpStreamRequestFactory;
use Guzzle\Service\Command\CommandInterface;

/**
 * Amazon S3 stream wrapper to use &quot;s3://&lt;bucket&gt;/&lt;key&gt;&quot; files with PHP streams, supporting &quot;r&quot;, &quot;w&quot;, &quot;a&quot;, &quot;x&quot;.
 *
 * # Supported stream related PHP functions:
 * - fopen, fclose, fread, fwrite, fseek, ftell, feof, fflush
 * - opendir, closedir, readdir, rewinddir
 * - copy, rename, unlink
 * - mkdir, rmdir, rmdir (recursive)
 * - file_get_contents, file_put_contents
 * - file_exists, filesize, is_file, is_dir
 *
 * # Opening &quot;r&quot; (read only) streams:
 *
 * Read only streams are truly streaming by default and will not allow you to seek. This is because data
 * read from the stream is not kept in memory or on the local filesystem. You can force a &quot;r&quot; stream to be seekable
 * by setting the &quot;seekable&quot; stream context option true. This will allow true streaming of data from Amazon S3, but
 * will maintain a buffer of previously read bytes in a &#x27;php://temp&#x27; stream to allow seeking to previously read bytes
 * from the stream.
 *
 * You may pass any GetObject parameters as &#x27;s3&#x27; stream context options. These options will affect how the data is
 * downloaded from Amazon S3.
 *
 * # Opening &quot;w&quot; and &quot;x&quot; (write only) streams:
 *
 * Because Amazon S3 requires a Content-Length header, write only streams will maintain a &#x27;php://temp&#x27; stream to buffer
 * data written to the stream until the stream is flushed (usually by closing the stream with fclose).
 *
 * You may pass any PutObject parameters as &#x27;s3&#x27; stream context options. These options will affect how the data is
 * uploaded to Amazon S3.
 *
 * When opening an &quot;x&quot; stream, the file must exist on Amazon S3 for the stream to open successfully.
 *
 * # Opening &quot;a&quot; (write only append) streams:
 *
 * Similar to &quot;w&quot; streams, opening append streams requires that the data be buffered in a &quot;php://temp&quot; stream. Append
 * streams will attempt to download the contents of an object in Amazon S3, seek to the end of the object, then allow
 * you to append to the contents of the object. The data will then be uploaded using a PutObject operation when the
 * stream is flushed (usually with fclose).
 *
 * You may pass any GetObject and/or PutObject parameters as &#x27;s3&#x27; stream context options. These options will affect how
 * the data is downloaded and uploaded from Amazon S3.
 *
 * Stream context options:
 *
 * - &quot;seekable&quot;: Set to true to create a seekable &quot;r&quot; (read only) stream by using a php://temp stream buffer
 * - &quot;throw_exceptions&quot;: Set to true to throw exceptions instead of trigger_errors
 * - For &quot;unlink&quot; only: Any option that can be passed to the DeleteObject operation
 */
class StreamWrapper
{
    /**
     * @var resource|null Stream context (this is set by PHP when a context is used)
     */
    public $context;

    /**
     * @var S3Client Client used to send requests
     */
    protected static $client;

    /**
     * @var string Mode the stream was opened with
     */
    protected $mode;

    /**
     * @var EntityBody Underlying stream resource
     */
    protected $body;

    /**
     * @var array Current parameters to use with the flush operation
     */
    protected $params;

    /**
     * @var ListObjectsIterator Iterator used with opendir() and subsequent readdir() calls
     */
    protected $objectIterator;

    /**
     * @var string The bucket that was opened when opendir() was called
     */
    protected $openedBucket;

    /**
     * @var string The prefix of the bucket that was opened with opendir()
     */
    protected $openedBucketPrefix;

    /**
     * @var array The next key to retrieve when using a directory iterator. Helps for fast directory traversal.
     */
    protected static $nextStat = array();

    /**
     * Register the &#x27;s3://&#x27; stream wrapper
     *
     * @param S3Client $client Client to use with the stream wrapper
     */
    public static function register(S3Client $client)
    {
        if (!in_array(&#x27;s3&#x27;, stream_get_wrappers())) {
            stream_wrapper_register(&#x27;s3&#x27;, __CLASS__, STREAM_IS_URL);
        }

        self::$client = $client;
    }

    /**
     * Close the stream
     */
    public function stream_close()
    {
        $this-&gt;body = null;
    }

    /**
     * @param string $path
     * @param string $mode
     * @param int    $options
     * @param string $opened_path
     *
     * @return bool
     */
    public function stream_open($path, $mode, $options, &amp;$opened_path)
    {
        // We don&#x27;t care about the binary flag
        $this-&gt;mode = $mode = rtrim($mode, &#x27;bt&#x27;);
        $this-&gt;params = $params = $this-&gt;getParams($path);
        $errors = array();

        if (!$params[&#x27;Key&#x27;]) {
            $errors[] = &#x27;Cannot open a bucket. You must specify a path in the form of s3://bucket/key&#x27;;
        }

        if (strpos($mode, &#x27;+&#x27;)) {
            $errors[] = &#x27;The Amazon S3 stream wrapper does not allow simultaneous reading and writing.&#x27;;
        }

        if (!in_array($mode, array(&#x27;r&#x27;, &#x27;w&#x27;, &#x27;a&#x27;, &#x27;x&#x27;))) {
            $errors[] = &quot;Mode not supported: {$mode}. Use one &#x27;r&#x27;, &#x27;w&#x27;, &#x27;a&#x27;, or &#x27;x&#x27;.&quot;;
        }

        // When using mode &quot;x&quot; validate if the file exists before attempting to read
        if ($mode == &#x27;x&#x27; &amp;&amp; !self::$client-&gt;doesObjectExist($params[&#x27;Bucket&#x27;], $params[&#x27;Key&#x27;], $this-&gt;getOptions())) {
            $errors[] = &quot;{$path} does not exist on Amazon S3&quot;;
        }

        if (!$errors) {
            if ($mode == &#x27;r&#x27;) {
                $this-&gt;openReadStream($params, $errors);
            } elseif ($mode == &#x27;a&#x27;) {
                $this-&gt;openAppendStream($params, $errors);
            } else {
                $this-&gt;openWriteStream($params, $errors);
            }
        }

        return $errors ? $this-&gt;triggerError($errors) : true;
    }

    /**
     * @return bool
     */
    public function stream_eof()
    {
        return $this-&gt;body-&gt;feof();
    }

    /**
     * @return bool
     */
    public function stream_flush()
    {
        if ($this-&gt;mode == &#x27;r&#x27;) {
            return false;
        }

        $this-&gt;body-&gt;rewind();
        $params = $this-&gt;params;
        $params[&#x27;Body&#x27;] = $this-&gt;body;

        try {
            self::$client-&gt;putObject($params);
            return true;
        } catch (\Exception $e) {
            return $this-&gt;triggerError($e-&gt;getMessage());
        }
    }

    /**
     * Read data from the underlying stream
     *
     * @param int $count Amount of bytes to read
     *
     * @return string
     */
    public function stream_read($count)
    {
        return $this-&gt;body-&gt;read($count);
    }

    /**
     * Seek to a specific byte in the stream
     *
     * @param int $offset Seek offset
     * @param int $whence Whence (SEEK_SET, SEEK_CUR, SEEK_END)
     *
     * @return bool
     */
    public function stream_seek($offset, $whence = SEEK_SET)
    {
        return $this-&gt;body-&gt;seek($offset, $whence);
    }

    /**
     * Get the current position of the stream
     *
     * @return int Returns the current position in the stream
     */
    public function stream_tell()
    {
        return $this-&gt;body-&gt;ftell();
    }

    /**
     * Write data the to the stream
     *
     * @param string $data
     *
     * @return int Returns the number of bytes written to the stream
     */
    public function stream_write($data)
    {
        return $this-&gt;body-&gt;write($data);
    }

    /**
     * Delete a specific object
     *
     * @param string $path
     * @return bool
     */
    public function unlink($path)
    {
        try {
            $this-&gt;clearStatInfo($path);
            self::$client-&gt;deleteObject($this-&gt;getParams($path));
            return true;
        } catch (\Exception $e) {
            return $this-&gt;triggerError($e-&gt;getMessage());
        }
    }

    /**
     * @return array
     */
    public function stream_stat()
    {
        return fstat($this-&gt;body-&gt;getStream());
    }

    /**
     * Provides information for is_dir, is_file, filesize, etc. Works on buckets, keys, and prefixes
     *
     * @param string $path
     * @param int    $flags
     *
     * @return array Returns an array of stat data
     * @link http://www.php.net/manual/en/streamwrapper.url-stat.php
     */
    public function url_stat($path, $flags)
    {
        // Check if this path is in the url_stat cache
        if (isset(self::$nextStat[$path])) {
            return self::$nextStat[$path];
        }

        $parts = $this-&gt;getParams($path);

        // Stat a bucket or just s3://
        if (!$parts[&#x27;Key&#x27;] &amp;&amp; (!$parts[&#x27;Bucket&#x27;] || self::$client-&gt;doesBucketExist($parts[&#x27;Bucket&#x27;]))) {
            return $this-&gt;formatUrlStat($path);
        }

        // You must pass either a bucket or a bucket + key
        if (!$parts[&#x27;Key&#x27;]) {
            return $this-&gt;triggerError(&quot;File or directory not found: {$path}&quot;, $flags);
        }

        try {
            try {
                // Attempt to stat and cache regular object
                return $this-&gt;formatUrlStat(self::$client-&gt;headObject($parts)-&gt;toArray());
            } catch (NoSuchKeyException $e) {
                // Maybe this isn&#x27;t an actual key, but a prefix. Do a prefix listing of objects to determine.
                $result = self::$client-&gt;listObjects(array(
                    &#x27;Bucket&#x27;  =&gt; $parts[&#x27;Bucket&#x27;],
                    &#x27;Prefix&#x27;  =&gt; $parts[&#x27;Key&#x27;],
                    &#x27;MaxKeys&#x27; =&gt; 1
                ));
                if (!$result[&#x27;Contents&#x27;] &amp;&amp; !$result[&#x27;CommonPrefixes&#x27;]) {
                    return $this-&gt;triggerError(&quot;File or directory not found: {$path}&quot;, $flags);
                }
                // This is a directory prefix
                return $this-&gt;formatUrlStat($path);
            }
        } catch (\Exception $e) {
            return $this-&gt;triggerError($e-&gt;getMessage(), $flags);
        }
    }

    /**
     * Support for mkdir().
     *
     * @param string $path    Directory which should be created.
     * @param int    $mode    Permissions. 700-range permissions map to ACL_PUBLIC. 600-range permissions map to
     *                        ACL_AUTH_READ. All other permissions map to ACL_PRIVATE. Expects octal form.
     * @param int    $options A bitwise mask of values, such as STREAM_MKDIR_RECURSIVE. (unused)
     *
     * @return bool
     * @link http://www.php.net/manual/en/streamwrapper.mkdir.php
     */
    public function mkdir($path, $mode, $options)
    {
        $params = $this-&gt;getParams($path);
        $this-&gt;clearStatInfo($path);

        if (!$params[&#x27;Bucket&#x27;] || $params[&#x27;Key&#x27;]) {
            return false;
        }

        try {
            if (!isset($params[&#x27;ACL&#x27;])) {
                $mode = decoct($mode);
                if ($mode &gt;= 700 and $mode &lt;= 799) {
                    $params[&#x27;ACL&#x27;] = &#x27;public-read&#x27;;
                } elseif ($mode &gt;= 600 &amp;&amp; $mode &lt;= 699) {
                    $params[&#x27;ACL&#x27;] = &#x27;authenticated-read&#x27;;
                } else {
                    $params[&#x27;ACL&#x27;] = &#x27;private&#x27;;
                }
            }
            self::$client-&gt;createBucket($params);
            return true;
        } catch (\Exception $e) {
            return $this-&gt;triggerError($e-&gt;getMessage());
        }
    }

    /**
     * Remove a bucket from Amazon S3
     *
     * @param string $path the directory path
     *
     * @return bool true if directory was successfully removed
     * @link http://www.php.net/manual/en/streamwrapper.rmdir.php
     */
    public function rmdir($path)
    {
        $params = $this-&gt;getParams($path);
        if (!$params[&#x27;Bucket&#x27;]) {
            return $this-&gt;triggerError(&#x27;You cannot delete s3://. Please specify a bucket.&#x27;);
        } elseif ($params[&#x27;Key&#x27;]) {
            return $this-&gt;triggerError(&#x27;rmdir() only supports bucket deletion&#x27;);
        }

        try {
            self::$client-&gt;deleteBucket(array(&#x27;Bucket&#x27; =&gt; $params[&#x27;Bucket&#x27;]));
            $this-&gt;clearStatInfo($path);
            return true;
        } catch (\Exception $e) {
            return $this-&gt;triggerError($e-&gt;getMessage());
        }
    }

    /**
     * Support for opendir().
     *
     * @param string $path    The path to the directory (e.g. &quot;s3://dir[&lt;/prefix&gt;]&quot;)
     * @param string $options Whether or not to enforce safe_mode (0x04). Unused.
     *
     * @return bool true on success
     * @see http://www.php.net/manual/en/function.opendir.php
     */
    public function dir_opendir($path, $options)
    {
        // Reset the cache
        $this-&gt;clearStatInfo();
        $params = $this-&gt;getParams($path);
        $delim = $this-&gt;getOption(&#x27;delimiter&#x27;) ?: &#x27;/&#x27;;
        if ($params[&#x27;Key&#x27;]) {
            $params[&#x27;Key&#x27;] = rtrim($params[&#x27;Key&#x27;], $delim) . $delim;
        }

        $this-&gt;openedBucket = $params[&#x27;Bucket&#x27;];
        $this-&gt;openedBucketPrefix = $params[&#x27;Key&#x27;];
        $this-&gt;objectIterator = self::$client-&gt;getIterator(&#x27;ListObjects&#x27;, array(
            &#x27;Bucket&#x27;    =&gt; $params[&#x27;Bucket&#x27;],
            &#x27;Delimiter&#x27; =&gt; $delim,
            &#x27;Prefix&#x27;    =&gt; $params[&#x27;Key&#x27;]
        ), array(
            &#x27;return_prefixes&#x27; =&gt; true,
            &#x27;sort_results&#x27;    =&gt; true
        ));

        $this-&gt;objectIterator-&gt;next();

        return true;
    }

    /**
     * Close the directory listing handles
     *
     * @return bool true on success
     */
    public function dir_closedir()
    {
        $this-&gt;objectIterator = null;

        return true;
    }

    /**
     * This method is called in response to rewinddir()
     *
     * @return boolean true on success
     */
    public function dir_rewinddir()
    {
        $this-&gt;clearStatInfo();
        $this-&gt;objectIterator-&gt;rewind();

        return true;
    }

    /**
     * This method is called in response to readdir()
     *
     * @return string Should return a string representing the next filename, or false if there is no next file.
     *
     * @link http://www.php.net/manual/en/function.readdir.php
     */
    public function dir_readdir()
    {
        $result = false;
        if ($this-&gt;objectIterator-&gt;valid()) {
            $current = $this-&gt;objectIterator-&gt;current();
            if (isset($current[&#x27;Prefix&#x27;])) {
                // Include &quot;directories&quot;
                $result = str_replace($this-&gt;openedBucketPrefix, &#x27;&#x27;, $current[&#x27;Prefix&#x27;]);
                $key = &quot;s3://{$this-&gt;openedBucket}/{$current[&#x27;Prefix&#x27;]}&quot;;
                $stat = $this-&gt;formatUrlStat($current[&#x27;Prefix&#x27;]);
            } else {
                // Remove the prefix from the result to emulate other stream wrappers
                $result = str_replace($this-&gt;openedBucketPrefix, &#x27;&#x27;, $current[&#x27;Key&#x27;]);
                $key = &quot;s3://{$this-&gt;openedBucket}/{$current[&#x27;Key&#x27;]}&quot;;
                $stat = $this-&gt;formatUrlStat($current);
            }

            // Cache the object data for quick url_stat lookups used with RecursiveDirectoryIterator
            self::$nextStat = array($key =&gt; $stat);
            $this-&gt;objectIterator-&gt;next();
        }

        return $result;
    }

    /**
     * Called in response to rename() to rename a file or directory. Currently only supports renaming objects.
     *
     * @param string $path_from the path to the file to rename
     * @param string $path_to   the new path to the file
     *
     * @return bool true if file was successfully renamed
     * @link http://www.php.net/manual/en/function.rename.php
     */
    public function rename($path_from, $path_to)
    {
        $partsFrom = $this-&gt;getParams($path_from);
        $partsTo = $this-&gt;getParams($path_to);
        $this-&gt;clearStatInfo($path_from);
        $this-&gt;clearStatInfo($path_to);

        if (!$partsFrom[&#x27;Key&#x27;] || !$partsTo[&#x27;Key&#x27;]) {
            return $this-&gt;triggerError(&#x27;The Amazon S3 stream wrapper only supports copying objects&#x27;);
        }

        try {
            // Copy the object and allow overriding default parameters if desired, but by default copy metadata
            self::$client-&gt;copyObject($this-&gt;getOptions() + array(
                &#x27;Bucket&#x27; =&gt; $partsTo[&#x27;Bucket&#x27;],
                &#x27;Key&#x27; =&gt; $partsTo[&#x27;Key&#x27;],
                &#x27;CopySource&#x27; =&gt; &#x27;/&#x27; . $partsFrom[&#x27;Bucket&#x27;] . &#x27;/&#x27; . rawurlencode($partsFrom[&#x27;Key&#x27;]),
                &#x27;MetadataDirective&#x27; =&gt; &#x27;COPY&#x27;
            ));
            // Delete the original object
            self::$client-&gt;deleteObject(array(
                &#x27;Bucket&#x27; =&gt; $partsFrom[&#x27;Bucket&#x27;],
                &#x27;Key&#x27;    =&gt; $partsFrom[&#x27;Key&#x27;]
            ) + $this-&gt;getOptions());
        } catch (\Exception $e) {
            return $this-&gt;triggerError($e-&gt;getMessage());
        }

        return true;
    }

    /**
     * Cast the stream to return the underlying file resource
     *
     * @param int $cast_as STREAM_CAST_FOR_SELECT or STREAM_CAST_AS_STREAM
     *
     * @return resource
     */
    public function stream_cast($cast_as)
    {
        return $this-&gt;body-&gt;getStream();
    }

    /**
     * Get the stream context options available to the current stream
     *
     * @return array
     */
    protected function getOptions()
    {
        $context = $this-&gt;context ?: stream_context_get_default();
        $options = stream_context_get_options($context);

        return isset($options[&#x27;s3&#x27;]) ? $options[&#x27;s3&#x27;] : array();
    }

    /**
     * Get a specific stream context option
     *
     * @param string $name Name of the option to retrieve
     *
     * @return mixed|null
     */
    protected function getOption($name)
    {
        $options = $this-&gt;getOptions();

        return isset($options[$name]) ? $options[$name] : null;
    }

    /**
     * Get the bucket and key from the passed path (e.g. s3://bucket/key)
     *
     * @param string $path Path passed to the stream wrapper
     *
     * @return array Hash of &#x27;Bucket&#x27;, &#x27;Key&#x27;, and custom params
     */
    protected function getParams($path)
    {
        $parts = explode(&#x27;/&#x27;, substr($path, 5), 2);

        $params = $this-&gt;getOptions();
        unset($params[&#x27;seekable&#x27;]);
        unset($params[&#x27;throw_exceptions&#x27;]);

        return array(
            &#x27;Bucket&#x27; =&gt; $parts[0],
            &#x27;Key&#x27;    =&gt; isset($parts[1]) ? $parts[1] : null
        ) + $params;
    }

    /**
     * Serialize and sign a command, returning a request object
     *
     * @param CommandInterface $command Command to sign
     *
     * @return RequestInterface
     */
    protected function getSignedRequest($command)
    {
        $request = $command-&gt;prepare();
        $request-&gt;dispatch(&#x27;request.before_send&#x27;, array(&#x27;request&#x27; =&gt; $request));

        return $request;
    }

    /**
     * Initialize the stream wrapper for a read only stream
     *
     * @param array $params Operation parameters
     * @param array $errors Any encountered errors to append to
     *
     * @return bool
     */
    protected function openReadStream(array $params, array &amp;$errors)
    {
        // Create the command and serialize the request
        $request = $this-&gt;getSignedRequest(self::$client-&gt;getCommand(&#x27;GetObject&#x27;, $params));
        // Create a stream that uses the EntityBody object
        $factory = $this-&gt;getOption(&#x27;stream_factory&#x27;) ?: new PhpStreamRequestFactory();
        $this-&gt;body = $factory-&gt;fromRequest($request, array(), array(&#x27;stream_class&#x27; =&gt; &#x27;Guzzle\Http\EntityBody&#x27;));

        // Wrap the body in a caching entity body if seeking is allowed
        if ($this-&gt;getOption(&#x27;seekable&#x27;)) {
            $this-&gt;body = new CachingEntityBody($this-&gt;body);
        }

        return true;
    }

    /**
     * Initialize the stream wrapper for a write only stream
     *
     * @param array $params Operation parameters
     * @param array $errors Any encountered errors to append to
     *
     * @return bool
     */
    protected function openWriteStream(array $params, array &amp;$errors)
    {
        $this-&gt;body = new EntityBody(fopen(&#x27;php://temp&#x27;, &#x27;r+&#x27;));
    }

    /**
     * Initialize the stream wrapper for an append stream
     *
     * @param array $params Operation parameters
     * @param array $errors Any encountered errors to append to
     *
     * @return bool
     */
    protected function openAppendStream(array $params, array &amp;$errors)
    {
        try {
            // Get the body of the object
            $this-&gt;body = self::$client-&gt;getObject($params)-&gt;get(&#x27;Body&#x27;);
            $this-&gt;body-&gt;seek(0, SEEK_END);
        } catch (S3Exception $e) {
            // The object does not exist, so use a simple write stream
            $this-&gt;openWriteStream($params, $errors);
        }

        return true;
    }

    /**
     * Trigger one or more errors
     *
     * @param string|array $errors Errors to trigger
     * @param mixed        $flags  If set to STREAM_URL_STAT_QUIET, then no error or exception occurs
     *
     * @return bool Returns false
     * @throws RuntimeException if throw_errors is true
     */
    protected function triggerError($errors, $flags = null)
    {
        if ($flags != STREAM_URL_STAT_QUIET) {
            if ($this-&gt;getOption(&#x27;throw_exceptions&#x27;)) {
                throw new RuntimeException(implode(&quot;\n&quot;, (array) $errors));
            } else {
                trigger_error(implode(&quot;\n&quot;, (array) $errors), E_USER_WARNING);
            }
        }

        return false;
    }

    /**
     * Prepare a url_stat result array
     *
     * @param string|array $result Data to add
     *
     * @return array Returns the modified url_stat result
     */
    protected function formatUrlStat($result = null)
    {
        static $statTemplate = array(
            0  =&gt; 0,  &#x27;dev&#x27;     =&gt; 0,
            1  =&gt; 0,  &#x27;ino&#x27;     =&gt; 0,
            2  =&gt; 0,  &#x27;mode&#x27;    =&gt; 0,
            3  =&gt; 0,  &#x27;nlink&#x27;   =&gt; 0,
            4  =&gt; 0,  &#x27;uid&#x27;     =&gt; 0,
            5  =&gt; 0,  &#x27;gid&#x27;     =&gt; 0,
            6  =&gt; -1, &#x27;rdev&#x27;    =&gt; -1,
            7  =&gt; 0,  &#x27;size&#x27;    =&gt; 0,
            8  =&gt; 0,  &#x27;atime&#x27;   =&gt; 0,
            9  =&gt; 0,  &#x27;mtime&#x27;   =&gt; 0,
            10 =&gt; 0,  &#x27;ctime&#x27;   =&gt; 0,
            11 =&gt; -1, &#x27;blksize&#x27; =&gt; -1,
            12 =&gt; -1, &#x27;blocks&#x27;  =&gt; -1,
        );

        $stat = $statTemplate;

        // Determine what type of data is being cached
        if (!$result || is_string($result)) {
            // Directory with 0777 access - see &quot;man 2 stat&quot;.
            $stat[&#x27;mode&#x27;] = $stat[2] = 0040777;
        } elseif (is_array($result) &amp;&amp; isset($result[&#x27;LastModified&#x27;])) {
            // ListObjects or HeadObject result
            $stat[&#x27;mtime&#x27;] = $stat[9] = $stat[&#x27;ctime&#x27;] = $stat[10] = strtotime($result[&#x27;LastModified&#x27;]);
            $stat[&#x27;size&#x27;] = $stat[7] = (isset($result[&#x27;ContentLength&#x27;]) ? $result[&#x27;ContentLength&#x27;] : $result[&#x27;Size&#x27;]);
            // Regular file with 0777 access - see &quot;man 2 stat&quot;.
            $stat[&#x27;mode&#x27;] = $stat[2] = 0100777;
        } else {
            $stat[&#x27;mode&#x27;] = $stat[2] = 0100777;
        }

        return $stat;
    }

    /**
     * Clear the next stat result from the cache
     *
     * @param string $path If a path is specific, clearstatcache() will be called
     */
    protected function clearStatInfo($path = null)
    {
        self::$nextStat = array();
        if ($path) {
            clearstatcache(true, $path);
        }
    }
}

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
