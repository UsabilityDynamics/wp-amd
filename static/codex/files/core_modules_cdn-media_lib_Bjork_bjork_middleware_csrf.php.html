<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/modules/cdn-media/lib/Bjork/bjork/middleware/csrf.php - wp-flawless</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://a3d72a45d111006ec192-ec5b80a12b0b09b4d52373336afb4254.r80.cf1.rackcdn.com/usability-dynamics.png" title="wp-flawless"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/API.html">API</a></li>
            
                <li><a href="../classes/Carrington.html">Carrington</a></li>
            
                <li><a href="../classes/Extended_Taxonomies.html">Extended_Taxonomies</a></li>
            
                <li><a href="../classes/Flawless.API.html">Flawless.API</a></li>
            
                <li><a href="../classes/Flawless.Asset.html">Flawless.Asset</a></li>
            
                <li><a href="../classes/Flawless.Branded_Login.html">Flawless.Branded_Login</a></li>
            
                <li><a href="../classes/Flawless.BuddyPress.html">Flawless.BuddyPress</a></li>
            
                <li><a href="../classes/Flawless.Content.html">Flawless.Content</a></li>
            
                <li><a href="../classes/Flawless.Element.html">Flawless.Element</a></li>
            
                <li><a href="../classes/Flawless.Flawless\Shortcode.html">Flawless.Flawless\Shortcode</a></li>
            
                <li><a href="../classes/Flawless.Management.html">Flawless.Management</a></li>
            
                <li><a href="../classes/Flawless.Mobile.html">Flawless.Mobile</a></li>
            
                <li><a href="../classes/Flawless.Navbars.html">Flawless.Navbars</a></li>
            
                <li><a href="../classes/Flawless.Schema.html">Flawless.Schema</a></li>
            
                <li><a href="../classes/Flawless.Settings.html">Flawless.Settings</a></li>
            
                <li><a href="../classes/Flawless.Styles.html">Flawless.Styles</a></li>
            
                <li><a href="../classes/Flawless.Utility.html">Flawless.Utility</a></li>
            
                <li><a href="../classes/Flawless.Widget.html">Flawless.Widget</a></li>
            
                <li><a href="../classes/flawless_wpp_extensions.html">flawless_wpp_extensions</a></li>
            
                <li><a href="../classes/Legacy.html">Legacy</a></li>
            
                <li><a href="../classes/License.html">License</a></li>
            
                <li><a href="../classes/Loader.html">Loader</a></li>
            
                <li><a href="../classes/Log.html">Log</a></li>
            
                <li><a href="../classes/Maintenance.html">Maintenance</a></li>
            
                <li><a href="../classes/Models.html">Models</a></li>
            
                <li><a href="../classes/Module.html">Module</a></li>
            
                <li><a href="../classes/Multisite.html">Multisite</a></li>
            
                <li><a href="../classes/SaaS.html">SaaS</a></li>
            
                <li><a href="../classes/Shortcode.html">Shortcode</a></li>
            
                <li><a href="../classes/Shortcodes.html">Shortcodes</a></li>
            
                <li><a href="../classes/Template Methods.html">Template Methods</a></li>
            
                <li><a href="../classes/Theme.html">Theme</a></li>
            
                <li><a href="../classes/UI.html">UI</a></li>
            
                <li><a href="../classes/Utility.html">Utility</a></li>
            
                <li><a href="../classes/Views.html">Views</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/API.html">API</a></li>
            
                <li><a href="../modules/Branded Login.html">Branded Login</a></li>
            
                <li><a href="../modules/Carrington.html">Carrington</a></li>
            
                <li><a href="../modules/Carrington Build.html">Carrington Build</a></li>
            
                <li><a href="../modules/carrington-build.html">carrington-build</a></li>
            
                <li><a href="../modules/cfct_build.html">cfct_build</a></li>
            
                <li><a href="../modules/default.html">default</a></li>
            
                <li><a href="../modules/Flawless.html">Flawless</a></li>
            
                <li><a href="../modules/Loader.html">Loader</a></li>
            
                <li><a href="../modules/Log.html">Log</a></li>
            
                <li><a href="../modules/Maintenence.html">Maintenence</a></li>
            
                <li><a href="../modules/Management.html">Management</a></li>
            
                <li><a href="../modules/Multisite.html">Multisite</a></li>
            
                <li><a href="../modules/SaaS.html">SaaS</a></li>
            
                <li><a href="../modules/Services_JSON.html">Services_JSON</a></li>
            
                <li><a href="../modules/Shortcodes.html">Shortcodes</a></li>
            
                <li><a href="../modules/taxonomy-landing

This file is part of Taxonomy Landing for WordPress
http:__github.com_crowdfavorite_wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http:__crowdfavorite.com

Released under the GPL license
http:__www.opensource.org_licenses_gpl-license.php

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************.html">taxonomy-landing

This file is part of Taxonomy Landing for WordPress
http://github.com/crowdfavorite/wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http://crowdfavorite.com

Released under the GPL license
http://www.opensource.org/licenses/gpl-license.php

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************</a></li>
            
                <li><a href="../modules/taxonomy-landing

This file is part of Taxonomy Landing for WordPress
https:__github.com_crowdfavorite_wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http:__crowdfavorite.com

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************.html">taxonomy-landing

This file is part of Taxonomy Landing for WordPress
https://github.com/crowdfavorite/wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http://crowdfavorite.com

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************</a></li>
            
                <li><a href="../modules/Theme UI.html">Theme UI</a></li>
            
                <li><a href="../modules/UI.html">UI</a></li>
            
                <li><a href="../modules/UsabilityDynamics.html">UsabilityDynamics</a></li>
            
                <li><a href="../modules/Utility.html">Utility</a></li>
            
                <li><a href="../modules/Views.html">Views</a></li>
            
                <li><a href="../modules/WP-Property.html">WP-Property</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: core/modules/cdn-media/lib/Bjork/bjork/middleware/csrf.php</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&lt;?php

namespace bjork\middleware\csrf {

use bjork\conf\settings,
    bjork\middleware\csrf,
    bjork\utils\crypto,
    bjork\utils\functional,
    bjork\utils\http;

/**
* Middleware that requires a present and correct csrfmiddlewaretoken
* for POST requests that have a CSRF cookie, and sets an outgoing
* CSRF cookie.
* 
* This middleware should be used in conjunction with the csrf_token template
* tag.
*/
class CsrfViewMiddleware {
    
    function processView($request, $callback, $args, $kwargs) {
        if ($request-&gt;get(&#x27;csrf_processing_done&#x27;, false))
            return null;
        
        $cookie = $request-&gt;COOKIES-&gt;get(settings::get(&#x27;CSRF_COOKIE_NAME&#x27;), null);
        if (null !== $cookie) {
            $csrf_token = csrf::sanitize_token($cookie);
            // use same token next time
            $request-&gt;META[&#x27;CSRF_COOKIE&#x27;] = $csrf_token;
        } else {
            $csrf_token = null;
            // Generate token and store it in the request, so it&#x27;s
            // available to the view.
            $request-&gt;META[&#x27;CSRF_COOKIE&#x27;] = csrf::get_new_csrf_key();
        }
        
        // Wait until request.META[&quot;CSRF_COOKIE&quot;] has been manipulated before
        // bailing out, so that get_token still works
        // @TODO: work around the fact php can&#x27;t have function decorators.
        if (in_array($callback, settings::get(&#x27;CSRF_EXEMPT_VIEWS&#x27;)))
            return null;
        
        // Assume that anything not defined as &#x27;safe&#x27; by RC2616 needs protection.
        if (!in_array($request-&gt;getMethod(), array(&#x27;GET&#x27;, &#x27;HEAD&#x27;, &#x27;OPTIONS&#x27;, &#x27;TRACE&#x27;))) {
            if ($request-&gt;get(&#x27;_dont_enforce_csrf_checks&#x27;, false))
                // Mechanism to turn off CSRF checks for test suite. It comes after
                // the creation of CSRF cookies, so that everything else continues to
                // work exactly the same (e.g. cookies are sent etc), but before
                // any branches that call reject()
                return $this-&gt;accept($request);
            
            if ($request-&gt;isSecure()) {
                // Suppose user visits http://example.com/
                // An active network attacker,(man-in-the-middle, MITM) sends a
                // POST form which targets https://example.com/detonate-bomb/ and
                // submits it via javascript.
                // 
                // The attacker will need to provide a CSRF cookie and token, but
                // that is no problem for a MITM and the session independent
                // nonce we are using. So the MITM can circumvent the CSRF
                // protection. This is true for any HTTP connection, but anyone
                // using HTTPS expects better!  For this reason, for
                // https://example.com/ we need additional protection that treats
                // http://example.com/ as completely untrusted.  Under HTTPS,
                // Barth et al. found that the Referer header is missing for
                // same-domain requests in only about 0.2% of cases or less, so
                // we can use strict Referer checking.
                $referer = $request-&gt;META-&gt;get(&#x27;HTTP_REFERER&#x27;);
                if (null === $referer)
                    // @TODO: log
                    return $this-&gt;reject($request, csrf::REASON_NO_REFERER);
                
                // Note that request.get_host() includes the port
                $good_referer = &quot;https://{$request-&gt;getHost()}/&quot;;
                if (!http::same_origin($referer, $good_referer)) {
                    $reason = sprintf(csrf::REASON_BAD_REFERER,
                        $referer, $good_referer);
                    // @TODO: log
                    return $this-&gt;reject($request, $reason);
                }
            }
            
            if (null === $csrf_token)
                // No CSRF cookie. For POST requests, we insist on a CSRF cookie,
                // and in this way we can avoid all CSRF attacks, including login
                // CSRF.
                // @TODO: log
                return $this-&gt;reject($request, csrf::REASON_NO_CSRF_COOKIE);
            
            // check non-cookie token for match
            $request_csrf_token = &#x27;&#x27;;
            if ($request-&gt;getMethod() === &#x27;POST&#x27;)
                $request_csrf_token = $request-&gt;POST-&gt;get(&#x27;csrfmiddlewaretoken&#x27;, &#x27;&#x27;);
            if ($request_csrf_token === &#x27;&#x27;)
                // Fall back to X-CSRFToken, to make things easier for AJAX,
                // and possible for PUT/DELETE
                $request_csrf_token = $request-&gt;META-&gt;get(&#x27;HTTP_X_CSRFTOKEN&#x27;, &#x27;&#x27;);
            
            if (!crypto::constant_time_compare($request_csrf_token, $csrf_token))
                // @TODO: log
                return $this-&gt;reject($request, csrf::REASON_BAD_TOKEN);
        }
        
        return $this-&gt;accept($request);
    }
    
    function processResponse($request, $response) {
        if ($response-&gt;getAttribute(&#x27;csrf_processing_done&#x27;, false))
            return $response;
        
        // If CSRF_COOKIE is unset, then CsrfViewMiddleware.process_view was
        // never called, probably because a request middleware returned a
        // response (for example, contrib.auth redirecting to a login page).
        if (null === $request-&gt;META-&gt;get(&#x27;CSRF_COOKIE&#x27;))
            return $response;
        
        if (!$request-&gt;META-&gt;get(&#x27;CSRF_COOKIE_USED&#x27;, false))
            return $response;
        
        $response-&gt;setCookie(
            settings::get(&#x27;CSRF_COOKIE_NAME&#x27;),
            $request-&gt;META[&#x27;CSRF_COOKIE&#x27;],
            array(
                &#x27;max_age&#x27; =&gt; 60 * 60 * 24 * 7 * 52,
                &#x27;secure&#x27;  =&gt; settings::get(&#x27;CSRF_COOKIE_SECURE&#x27;),
                &#x27;domain&#x27;  =&gt; settings::get(&#x27;CSRF_COOKIE_DOMAIN&#x27;),
                &#x27;path&#x27;    =&gt; settings::get(&#x27;CSRF_COOKIE_PATH&#x27;),
            )
        );
        
        $response-&gt;setAttribute(&#x27;csrf_processing_done&#x27;, true);
        return $response;
    }
    
    protected function accept($request) {
        // Avoid checking the request twice by adding a custom attribute to
        // request. This will be relevant when both decorator and middleware
        // are used.
        $request[&#x27;csrf_processing_done&#x27;] = true;
        return null;
    }
    
    protected function reject($request, $reason) {
        return functional::call_user_func_assoc(csrf::get_failure_view(), array(
            &#x27;request&#x27; =&gt; $request,
            &#x27;reason&#x27; =&gt; $reason,
        ));
    }
}

}

namespace bjork\middleware {

use bjork\conf\settings,
    bjork\core\exceptions\ImproperlyConfigured,
    bjork\utils\importlib;

final class csrf {
    
    const REASON_NO_REFERER = &#x27;Referer checking failed - no Referer.&#x27;;
    const REASON_BAD_REFERER = &#x27;Referer checking failed - %s does not match %s.&#x27;;
    const REASON_NO_CSRF_COOKIE = &#x27;CSRF cookie not set.&#x27;;
    const REASON_BAD_TOKEN = &#x27;CSRF token missing or incorrect.&#x27;;
    
    const MAX_CSRF_KEY = 18446744073709551616; // 2&lt;&lt;63
    
    /**
    * Returns the the CSRF token required for a POST form. The token is an
    * alphanumeric value.
    * 
    * A side effect of calling this function is to make the the csrf_protect
    * decorator and the CsrfViewMiddleware add a CSRF cookie and a
    * &#x27;Vary: Cookie&#x27; header to the outgoing response. For this reason, you
    * may need to use this function lazily, as is done by the csrf context
    * processor.
    */
    public static function get_token($request) {
        $request-&gt;META[&#x27;CSRF_COOKIE_USED&#x27;] = true;
        return $request-&gt;META-&gt;get(&#x27;CSRF_COOKIE&#x27;, null);
    }
    
    // protected
    
    static function sanitize_token($token) {
        // Allow only alphanum, and ensure we return a &#x27;str&#x27;
        // for the sake of the post processing middleware.
        $token = preg_replace(&#x27;/[^a-zA-Z0-9]/u&#x27;, &#x27;&#x27;, $token);
        if (empty($token))
            // In case the cookie has been truncated to nothing at some point.
            return self::get_new_csrf_key();
        return $token;
    }
    
    static function get_new_csrf_key() {
        $rnd = mt_rand(0, self::MAX_CSRF_KEY);
        $key = settings::get(&#x27;SECRET_KEY&#x27;);
        return md5($rnd . $key);
    }
    
    /**
    * Returns the view to be used for CSRF rejections.
    */
    static function get_failure_view() {
        $view = settings::get(&#x27;CSRF_FAILURE_VIEW&#x27;);
        importlib::import_class($view);
        if (!is_callable($view))
            throw new ImproperlyConfigured(&quot;{$view} is not callable&quot;);
        return $view;
    }
}

}

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
